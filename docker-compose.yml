# ArgusAI Docker Compose Configuration
# Story P10-2.4: Create docker-compose.yml
# Story P10-2.5: Add PostgreSQL Service
# Story P10-2.6: Add nginx Reverse Proxy with SSL
# Story P13-5.1: Add n8n Workflow Automation Service
#
# Usage:
#   docker-compose up -d                          # Start backend and frontend (SQLite)
#   docker-compose --profile postgres up -d       # Start with PostgreSQL
#   docker-compose --profile ssl up -d            # Start with nginx SSL reverse proxy
#   docker-compose --profile automation up -d     # Start with n8n workflow automation
#   docker-compose --profile postgres --profile ssl up -d  # PostgreSQL + SSL
#   docker-compose down                           # Stop containers (preserves volumes)
#   docker-compose logs -f                        # Follow logs
#   docker-compose ps                             # Show running containers
#
# PostgreSQL Usage:
#   1. Set DATABASE_URL=postgresql://argusai:your-password@postgres:5432/argusai in .env
#   2. Set POSTGRES_PASSWORD=your-password in .env
#   3. Run: docker-compose --profile postgres up -d
#
# SSL/HTTPS Usage (nginx reverse proxy):
#   1. Place SSL certificates in data/certs/:
#      - cert.pem: SSL certificate (or certificate chain)
#      - key.pem:  Private key
#   2. Run: docker-compose --profile ssl up -d
#   3. Access via https://localhost (port 443)
#
#   Generate self-signed certificates for testing:
#     mkdir -p data/certs
#     openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#       -keyout data/certs/key.pem \
#       -out data/certs/cert.pem \
#       -subj "/CN=localhost"
#
# Prerequisites:
#   - Copy .env.example to .env and configure required variables
#   - ENCRYPTION_KEY and JWT_SECRET_KEY are required

services:
  # ==============================================================================
  # Backend Service - FastAPI Application
  # ==============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: ghcr.io/project-argusai/argusai-backend:latest
    container_name: argusai-backend
    ports:
      - "8000:8000"
    environment:
      # Database configuration
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/app.db}
      # Required secrets
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      # Application settings
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://frontend:3000}
      # AI provider keys (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      # Push notifications (optional)
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      # SSL configuration (optional)
      - SSL_ENABLED=${SSL_ENABLED:-false}
      - SSL_CERT_FILE=${SSL_CERT_FILE:-data/certs/cert.pem}
      - SSL_KEY_FILE=${SSL_KEY_FILE:-data/certs/key.pem}
      # HomeKit (optional)
      - HOMEKIT_ENABLED=${HOMEKIT_ENABLED:-false}
      - HOMEKIT_PORT=${HOMEKIT_PORT:-51826}
      - HOMEKIT_BRIDGE_NAME=${HOMEKIT_BRIDGE_NAME:-ArgusAI}
      # MQTT (optional)
      - MQTT_ENABLED=${MQTT_ENABLED:-false}
      - MQTT_BROKER_HOST=${MQTT_BROKER_HOST:-}
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USERNAME:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
    volumes:
      # Named volume for persistent data (database, thumbnails, frames, certs, homekit)
      - argusai-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - argusai-net

  # ==============================================================================
  # Frontend Service - Next.js Application
  # ==============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Build-time API URL for Next.js (baked into build)
        NEXT_PUBLIC_API_URL: http://backend:8000
    image: ghcr.io/project-argusai/argusai-frontend:latest
    container_name: argusai-frontend
    ports:
      - "3000:3000"
    environment:
      # Runtime environment (for server-side rendering)
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - argusai-net

  # ==============================================================================
  # PostgreSQL Database Service (Optional - use with --profile postgres)
  # ==============================================================================
  # Story P10-2.5: Add PostgreSQL Service
  #
  # To use PostgreSQL instead of SQLite:
  #   1. Set POSTGRES_PASSWORD=your-secure-password in .env (defaults to 'changeme' if not set)
  #   2. Set DATABASE_URL=postgresql://argusai:your-password@postgres:5432/argusai in .env
  #   3. Run: docker-compose --profile postgres up -d
  #
  postgres:
    image: postgres:16-alpine
    container_name: argusai-postgres
    profiles:
      - postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-argusai}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-argusai}
    volumes:
      # Named volume for PostgreSQL data persistence
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-argusai} -d ${POSTGRES_DB:-argusai}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - argusai-net

  # ==============================================================================
  # nginx Reverse Proxy with SSL (Optional - use with --profile ssl)
  # ==============================================================================
  # Story P10-2.6: Add nginx Reverse Proxy with SSL
  #
  # Provides SSL termination and reverse proxy for secure production deployments.
  # Routes:
  #   - /api/*          -> backend:8000
  #   - /ws             -> backend:8000 (WebSocket)
  #   - /docs, /openapi -> backend:8000
  #   - /health         -> backend:8000
  #   - /metrics        -> backend:8000
  #   - /*              -> frontend:3000
  #
  # To use:
  #   1. Place SSL certificates in data/certs/ (cert.pem, key.pem)
  #   2. Run: docker-compose --profile ssl up -d
  #
  nginx:
    image: nginx:alpine
    container_name: argusai-nginx
    profiles:
      - ssl
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # nginx configuration (read-only for security)
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL certificates (read-only for security)
      - ./data/certs:/etc/nginx/certs:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - argusai-net

  # ==============================================================================
  # n8n Workflow Automation (Optional - use with --profile automation)
  # ==============================================================================
  # Story P13-5.1: Add n8n Service to Docker Compose
  #
  # Provides workflow automation for CI/CD pipelines, BMAD workflows, and GitHub
  # webhook integration. Can be used to automate story implementation, code review,
  # and PR management.
  #
  # To use:
  #   1. Set N8N_BASIC_AUTH_PASSWORD in .env (defaults to 'changeme')
  #   2. Run: docker-compose --profile automation up -d
  #   3. Access n8n at http://localhost:5678
  #
  # Environment variables (optional):
  #   - N8N_BASIC_AUTH_USER: Admin username (default: admin)
  #   - N8N_BASIC_AUTH_PASSWORD: Admin password (CHANGE IN PRODUCTION!)
  #   - N8N_WEBHOOK_URL: External webhook URL (default: http://localhost:5678)
  #   - NOTIFICATION_WEBHOOK_URL: Slack/Discord webhook for notifications
  #
  n8n:
    image: n8nio/n8n:latest
    container_name: argusai-n8n
    profiles:
      - automation
    ports:
      - "5678:5678"
    environment:
      # n8n configuration
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost:5678}
      # ArgusAI integration
      - ARGUSAI_PROJECT_PATH=/argusai
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Notification webhooks (optional)
      - NOTIFICATION_WEBHOOK_URL=${NOTIFICATION_WEBHOOK_URL:-}
      # GitHub integration (optional)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    volumes:
      # Named volume for n8n data persistence (workflows, credentials, execution history)
      - n8n-data:/home/node/.n8n
      # Mount project root for Claude Code CLI access (read-write for code changes)
      - ./:/argusai:rw
      # Mount workflow templates (read-only)
      - ./n8n/workflows:/home/node/workflows:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - argusai-net

# ==============================================================================
# Named Volumes - Persistent Storage
# ==============================================================================
volumes:
  # Backend data volume containing:
  # - app.db (SQLite database)
  # - thumbnails/ (event thumbnails)
  # - frames/ (video analysis frames)
  # - certs/ (SSL certificates)
  # - homekit/ (HomeKit pairing data)
  argusai-data:
    driver: local

  # PostgreSQL data volume (used with --profile postgres)
  # Story P10-2.5: Add PostgreSQL Service
  pgdata:
    driver: local

  # n8n data volume (used with --profile automation)
  # Story P13-5.1: Add n8n Service to Docker Compose
  n8n-data:
    driver: local

# ==============================================================================
# Networks - Internal Communication
# ==============================================================================
networks:
  # Bridge network for service-to-service communication
  # Frontend accesses backend via http://backend:8000
  argusai-net:
    driver: bridge
