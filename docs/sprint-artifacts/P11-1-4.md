# Story P11-1.4: Document Tunnel Setup in User Guide

Status: done

## Story

As a user,
I want clear documentation for setting up Cloudflare Tunnel,
so that I can configure remote access correctly.

## Acceptance Criteria

1. AC-1.4.1: Step-by-step guide for cloudflared installation (Linux, macOS, Windows)
2. AC-1.4.2: Instructions for creating tunnel in Cloudflare dashboard
3. AC-1.4.3: Configuration guide for ArgusAI settings
4. AC-1.4.4: Troubleshooting section for common issues
5. AC-1.4.5: Security considerations documented

## Tasks / Subtasks

- [x] Task 1: Create cloudflared installation guide (AC: 1.4.1)
  - [x] 1.1: Document installation steps for Linux (Debian/Ubuntu, RHEL/CentOS, Arch)
  - [x] 1.2: Document installation steps for macOS (Homebrew and manual)
  - [x] 1.3: Document installation steps for Windows (MSI and chocolatey)
  - [x] 1.4: Add verification commands to confirm installation
- [x] Task 2: Document Cloudflare Zero Trust dashboard setup (AC: 1.4.2)
  - [x] 2.1: Create Cloudflare account setup instructions
  - [x] 2.2: Document domain addition to Cloudflare
  - [x] 2.3: Walk through tunnel creation in Zero Trust dashboard
  - [x] 2.4: Explain tunnel token generation and copying
- [x] Task 3: Create ArgusAI configuration walkthrough (AC: 1.4.3)
  - [x] 3.1: Document navigating to Settings > Integrations > Tunnel
  - [x] 3.2: Explain token input and enable toggle
  - [x] 3.3: Document Test Connection button usage
  - [x] 3.4: Explain status indicator meanings
- [x] Task 4: Add troubleshooting FAQ (AC: 1.4.4)
  - [x] 4.1: Document "cloudflared not found" resolution
  - [x] 4.2: Document "Invalid tunnel token" errors
  - [x] 4.3: Document connection timeout issues
  - [x] 4.4: Document auto-reconnect behavior
  - [x] 4.5: Document firewall/proxy considerations
- [x] Task 5: Document security best practices (AC: 1.4.5)
  - [x] 5.1: Explain token security (never share, rotate if compromised)
  - [x] 5.2: Document Cloudflare Access policies (optional)
  - [x] 5.3: Explain TLS/encryption guarantees
  - [x] 5.4: Recommend custom domain over Cloudflare subdomain

## Dev Notes

### Documentation Location

The tunnel setup documentation should be created at `docs/guides/tunnel-setup.md` and linked from:
- README.md (Quick Start or Remote Access section)
- CLAUDE.md (Environment Variables section, near SSL configuration)

### Previous Story Implementation

From P11-1.3, the following components are now available:
- `frontend/components/settings/TunnelSettings.tsx` - UI component for tunnel configuration
- `frontend/lib/api-client.ts` - Tunnel API methods (`getTunnelStatus()`, `startTunnel()`, `stopTunnel()`)
- Backend endpoints at `backend/app/api/v1/system.py`:
  - `GET /api/v1/system/tunnel/status`
  - `POST /api/v1/system/tunnel/start`
  - `POST /api/v1/system/tunnel/stop`

### Cloudflared Installation References

Official documentation: https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-local-tunnel/

Installation methods:
- **Linux**: Package repositories or standalone binary
- **macOS**: Homebrew (`brew install cloudflared`) or download
- **Windows**: MSI installer or chocolatey (`choco install cloudflared`)

### Tunnel Token vs Credentials File

ArgusAI uses the newer **Tunnel Token** approach (not legacy credentials file):
1. User creates tunnel in Cloudflare Zero Trust dashboard
2. Dashboard generates a token (base64-encoded JSON)
3. Token is entered in ArgusAI Settings
4. ArgusAI stores token encrypted, starts tunnel with `cloudflared tunnel run --token <token>`

### Status Indicator States

Document these states from TunnelSettings.tsx:
- `disconnected` (gray): Tunnel not running
- `connecting` (yellow, pulsing): Starting up
- `connected` (green): Tunnel established
- `error` (red): Failed with error message

### Security Considerations to Document

1. **Token Security**: Tunnel tokens grant access to the tunnel - never commit to git or share
2. **Encryption**: All traffic through tunnel is TLS-encrypted
3. **Cloudflare Access**: Optional Zero Trust policies can restrict who can access
4. **No Port Forwarding**: Tunnel uses outbound connections only - no firewall holes needed
5. **Local Access Still Works**: Tunnel doesn't affect local network access

### Troubleshooting Scenarios

| Issue | Cause | Resolution |
|-------|-------|------------|
| "cloudflared not found" | Binary not in PATH | Install cloudflared or add to PATH |
| "Invalid tunnel token" | Token corrupted or expired | Regenerate token in Cloudflare dashboard |
| Connection timeout | Firewall blocking outbound 443 | Allow outbound HTTPS |
| Auto-reconnect failing | Network instability | Check logs, verify internet access |
| "Permission denied" | cloudflared lacks permissions | Run with appropriate user/permissions |

### Project Structure Notes

- New file: `docs/guides/tunnel-setup.md`
- Modify: `README.md` (add link to tunnel guide)
- Optional: `docs/guides/index.md` if guides directory is new

### References

- [Source: docs/epics-phase11.md#P11-1.4]
- [Source: docs/sprint-artifacts/tech-spec-epic-P11-1.md#AC-1.4.1-5]
- [Source: docs/architecture/cloud-relay-architecture.md] - Cloudflare Tunnel design
- [Source: docs/architecture/phase-11-additions.md#ADR-P11-001] - Tunnel decision rationale
- [Source: frontend/components/settings/TunnelSettings.tsx] - UI implementation
- [Source: backend/app/services/tunnel_service.py] - Backend service

### Learnings from Previous Story

**From Story P11-1-3 (Status: done)**

- **New Component Created**: `TunnelSettings.tsx` at `frontend/components/settings/TunnelSettings.tsx` - use as reference for UI screenshots
- **API Methods Available**: `getTunnelStatus()`, `startTunnel()`, `stopTunnel()` in api-client.ts
- **Status States**: disconnected, connecting, connected, error - document all four
- **Testing Patterns**: 28 component tests at `frontend/__tests__/components/settings/TunnelSettings.test.tsx`

[Source: docs/sprint-artifacts/P11-1-3.md#Dev-Agent-Record]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

- All 5 acceptance criteria implemented
- Created comprehensive tunnel setup guide with installation instructions for Linux, macOS, and Windows
- Documented Cloudflare Zero Trust dashboard workflow for tunnel creation
- Included ArgusAI-specific configuration steps with UI navigation
- Added troubleshooting section covering 6 common issues with solutions
- Documented security best practices including token security, Cloudflare Access, and encryption
- Updated README.md with Remote Access section and links to guide
- Updated "What's New" section to reflect Phase 11 progress

### File List

- docs/guides/tunnel-setup.md (NEW) - Comprehensive tunnel setup guide
- README.md (MODIFIED) - Added Remote Access section and documentation links
- docs/sprint-artifacts/P11-1-4.md (NEW) - Story file
- docs/sprint-artifacts/sprint-status.yaml (MODIFIED) - Story status updated

