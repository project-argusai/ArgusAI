# Story P11-2.1: Implement APNS Provider for iOS Push

Status: done

## Story

As an iOS user,
I want to receive push notifications on my iPhone/iPad,
so that I'm alerted to security events when away from home.

## Acceptance Criteria

1. AC-2.1.1: APNSProvider class connects via HTTP/2 to Apple's servers
2. AC-2.1.2: Authentication uses p8 auth key file
3. AC-2.1.3: Configuration stores key_id, team_id, key_file path
4. AC-2.1.4: Payloads formatted per Apple's notification format
5. AC-2.1.5: Error responses handled (invalid token, etc.)
6. AC-2.1.6: Token invalidation removes stale device tokens

## Tasks / Subtasks

- [x] Task 1: Create APNSProvider class (AC: 2.1.1, 2.1.2, 2.1.3)
  - [x] 1.1: Create `backend/app/services/push/` directory structure with `__init__.py`
  - [x] 1.2: Implement APNSProvider class with HTTP/2 client (httpx)
  - [x] 1.3: Implement JWT generation for APNS authentication (ES256 with p8 key)
  - [x] 1.4: Add APNSConfig pydantic model for configuration
  - [x] 1.5: Implement connection pooling with persistent HTTP/2 connections
- [x] Task 2: Add APNS configuration to system settings (AC: 2.1.3)
  - [x] 2.1: Add APNS environment variables (APNS_KEY_FILE, APNS_KEY_ID, APNS_TEAM_ID, APNS_BUNDLE_ID, APNS_USE_SANDBOX)
  - [x] 2.2: Update system settings model to store APNS configuration
  - [x] 2.3: Add APNS configuration to settings service
- [x] Task 3: Create iOS notification payload builder (AC: 2.1.4)
  - [x] 3.1: Implement APNSPayload pydantic model with aps dictionary structure
  - [x] 3.2: Add support for alert, badge, sound, mutable-content, category, thread-id
  - [x] 3.3: Create payload builder method that formats EventNotification for iOS
- [x] Task 4: Implement error handling for APNS responses (AC: 2.1.5, 2.1.6)
  - [x] 4.1: Handle 200 success responses and update last_used_at
  - [x] 4.2: Handle 400 Bad Request (log error)
  - [x] 4.3: Handle 403 Certificate/token issue (check auth configuration)
  - [x] 4.4: Handle 410 Token unregistered (delete token from database)
  - [x] 4.5: Handle 429 Too many requests (implement backoff)
  - [x] 4.6: Handle 500+ APNS server error (retry with backoff)
- [x] Task 5: Add token cleanup for invalidated tokens (AC: 2.1.6)
  - [x] 5.1: Create method to mark tokens as inactive when 410 received
  - [x] 5.2: Implement token cleanup that cascades to database
- [x] Task 6: Write unit tests with mocked APNS
  - [x] 6.1: Test JWT generation (valid signature, correct headers)
  - [x] 6.2: Test payload formatting (all aps fields)
  - [x] 6.3: Test error handling for each APNS response code
  - [x] 6.4: Test token invalidation flow
  - [x] 6.5: Test connection retry with backoff

## Dev Notes

### Project Structure

New files to create:
```
backend/app/services/push/
├── __init__.py
├── apns_provider.py      # APNS HTTP/2 client
├── models.py             # APNSConfig, APNSPayload, DeliveryResult
└── constants.py          # APNS hosts, error codes
```

### APNS Authentication Flow

ArgusAI uses **Token-Based Authentication** with an APNS Auth Key (.p8 file):

1. Load private key from .p8 file (PEM format, ES256)
2. Generate JWT with:
   - Header: `{"alg": "ES256", "kid": "<key_id>"}`
   - Payload: `{"iss": "<team_id>", "iat": <timestamp>}`
3. Sign with ES256 algorithm using the private key
4. JWT valid for 1 hour (regenerate as needed)

### APNS Endpoints

| Environment | Host |
|-------------|------|
| Sandbox | api.sandbox.push.apple.com |
| Production | api.push.apple.com |

Request: `POST /3/device/{device_token}`

### Required Headers

```
authorization: bearer <jwt>
apns-topic: <bundle_id>
apns-push-type: alert
apns-priority: 10
apns-expiration: 0
```

### APNS Payload Structure

```json
{
  "aps": {
    "alert": {
      "title": "Front Door: Person Detected",
      "body": "A person was detected at the front door at 10:30 AM",
      "subtitle": "Front Door Camera"
    },
    "badge": 1,
    "sound": "default",
    "mutable-content": 1,
    "category": "SECURITY_ALERT",
    "thread-id": "cam-789"
  },
  "event_id": "evt-123456",
  "camera_id": "cam-789",
  "camera_name": "Front Door",
  "smart_detection_type": "person",
  "thumbnail_url": "https://argusai.local/api/v1/events/evt-123456/thumbnail"
}
```

### Dependencies

Add to requirements.txt:
- `httpx[http2]>=0.26.0` - HTTP/2 client for APNS
- `PyJWT>=2.8.0` - JWT generation (already present)
- `cryptography>=41.0.0` - ES256 signing (already present)

### Error Response Handling

| Status | Reason | Action |
|--------|--------|--------|
| 200 | Success | Update last_used_at |
| 400 | BadDeviceToken | Log error, review payload |
| 403 | ExpiredProviderToken | Regenerate JWT |
| 410 | Unregistered | Delete token from database |
| 429 | TooManyRequests | Retry with exponential backoff |
| 500+ | ServiceUnavailable | Retry with backoff |

### Testing Strategy

- Unit tests mock httpx HTTP/2 responses
- Test JWT signature verification with test keys
- Test all error code handling paths
- Integration test requires Apple Developer account (deferred)

### References

- [Source: docs/api/mobile-push-architecture.md#APNS-Integration]
- [Source: docs/architecture/phase-11-additions.md#APNS-Provider]
- [Source: docs/sprint-artifacts/tech-spec-epic-P11-2.md#AC-2.1.1-6]
- [Source: docs/epics-phase11.md#P11-2.1]
- [Apple APNS Documentation](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server)

### Learnings from Previous Story

**From Story P11-1.4 (Status: done)**

- **Documentation Pattern**: Created comprehensive guide at `docs/guides/tunnel-setup.md`
- **README Updates**: Added new feature sections to README.md
- **Phase 11 Progress**: Epic P11-1 (Cloudflare Tunnel) is complete
- **Testing Coverage**: P11-1.3 had 28 component tests as reference pattern

[Source: docs/sprint-artifacts/P11-1-4.md#Completion-Notes-List]

### Important Notes

- This is the first story in Epic P11-2 (Mobile Push Notifications)
- Future stories P11-2.2 (FCM) and P11-2.3 (Dispatch) will build on this provider
- Story P11-2.4 (Device Registration) will create the Device model and API
- For now, focus on the provider itself - integration with dispatch comes later
- Token storage/management is handled in P11-2.4, not this story

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/stories/p11-2-1-implement-apns-provider-for-ios-push.context.xml

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

- All 6 acceptance criteria implemented
- Created APNS provider with HTTP/2 support via httpx
- Implemented JWT generation with ES256 signing using cryptography library
- Created Pydantic models: APNSConfig, APNSPayload, APNSAlert, DeliveryResult
- Added comprehensive error handling for all APNS response codes (200, 400, 403, 410, 429, 500+)
- Implemented retry logic with exponential backoff for transient errors
- Token invalidation callback for 410 responses (unregistered devices)
- Added APNS configuration to app settings (APNS_KEY_FILE, APNS_KEY_ID, APNS_TEAM_ID, APNS_BUNDLE_ID, APNS_USE_SANDBOX)
- Created format_event_for_apns helper function for consistent notification formatting
- 29 unit tests all passing with mocked APNS responses
- Updated requirements.txt with httpx[http2] and PyJWT dependencies

### File List

- backend/app/services/push/__init__.py (NEW) - Package init with exports
- backend/app/services/push/apns_provider.py (NEW) - APNS HTTP/2 client
- backend/app/services/push/models.py (NEW) - Pydantic models for APNS
- backend/app/services/push/constants.py (NEW) - APNS constants and error codes
- backend/app/core/config.py (MODIFIED) - Added APNS configuration settings
- backend/requirements.txt (MODIFIED) - Added httpx[http2] and PyJWT
- backend/tests/test_services/test_push/__init__.py (NEW) - Test package
- backend/tests/test_services/test_push/test_apns_provider.py (NEW) - 29 tests
