# Story P11-2.2: Implement FCM Provider for Android Push

Status: done

## Story

As an Android user,
I want to receive push notifications on my phone,
so that I'm alerted to security events when away from home.

## Acceptance Criteria

1. AC-2.2.1: FCMProvider class connects to FCM HTTP v1 API
2. AC-2.2.2: Authentication uses service account JSON file
3. AC-2.2.3: Configuration stores project_id and credentials_path securely
4. AC-2.2.4: Payloads formatted per FCM notification format
5. AC-2.2.5: Data messages supported for background processing
6. AC-2.2.6: Error responses handled (invalid token, quota exceeded, etc.)

## Tasks / Subtasks

- [x] Task 1: Create FCMProvider class (AC: 2.2.1, 2.2.2, 2.2.3)
  - [x] 1.1: Create `fcm_provider.py` in `backend/app/services/push/`
  - [x] 1.2: Implement FCMProvider class using firebase-admin SDK
  - [x] 1.3: Initialize Firebase Admin SDK with service account credentials
  - [x] 1.4: Add FCMConfig pydantic model for configuration
  - [x] 1.5: Implement async wrapper for blocking firebase-admin calls using asyncio.to_thread
- [x] Task 2: Add FCM configuration to system settings (AC: 2.2.3)
  - [x] 2.1: Add FCM environment variables (FCM_PROJECT_ID, FCM_CREDENTIALS_FILE)
  - [x] 2.2: Update app config.py to load FCM configuration
  - [x] 2.3: Validate credentials file exists on startup
- [x] Task 3: Create Android notification payload builder (AC: 2.2.4, 2.2.5)
  - [x] 3.1: Implement FCMPayload pydantic model with notification and data fields
  - [x] 3.2: Add AndroidConfig with priority, channel_id, icon settings
  - [x] 3.3: Support BigPicture style for image attachments
  - [x] 3.4: Create format_event_for_fcm helper function
- [x] Task 4: Implement data message support (AC: 2.2.5)
  - [x] 4.1: Support data-only messages for background processing
  - [x] 4.2: Include event_id, camera_id, camera_name in data payload
  - [x] 4.3: Support both notification+data and data-only modes
- [x] Task 5: Implement error handling for FCM responses (AC: 2.2.6)
  - [x] 5.1: Handle UnregisteredError (token invalid - delete from DB)
  - [x] 5.2: Handle QuotaExceededError (log, backoff)
  - [x] 5.3: Handle InvalidArgumentError (malformed request)
  - [x] 5.4: Handle ThirdPartyAuthError (credentials issue)
  - [x] 5.5: Implement retry logic with exponential backoff for transient errors
  - [x] 5.6: Add token invalidation callback similar to APNSProvider
- [x] Task 6: Write unit tests with mocked FCM
  - [x] 6.1: Test Firebase Admin SDK initialization
  - [x] 6.2: Test message building (notification, data, combined)
  - [x] 6.3: Test error handling for each exception type
  - [x] 6.4: Test token invalidation flow
  - [x] 6.5: Test retry with backoff logic
  - [x] 6.6: Test batch sending

## Dev Notes

### Project Structure

Extends existing push service structure from P11-2.1:
```
backend/app/services/push/
├── __init__.py          # Add FCMProvider export
├── apns_provider.py     # Existing from P11-2.1
├── fcm_provider.py      # NEW: FCM HTTP v1 client
├── models.py            # Add FCMConfig, FCMPayload models
└── constants.py         # Add FCM constants
```

### FCM Authentication Flow

FCM uses **Service Account Authentication**:

1. Download service account JSON from Firebase Console > Project Settings > Service Accounts
2. JSON file contains: `project_id`, `private_key`, `client_email`, etc.
3. Firebase Admin SDK handles OAuth2 token generation automatically
4. Tokens are cached and refreshed by the SDK

### FCM HTTP v1 API

Endpoint: `https://fcm.googleapis.com/v1/projects/{project_id}/messages:send`

The firebase-admin SDK wraps this API with `messaging.send()` and `messaging.send_all()`.

### FCM Message Structure

```python
message = messaging.Message(
    notification=messaging.Notification(
        title="Front Door: Person Detected",
        body="A person was detected at the front door",
        image="https://argusai.local/api/v1/events/{event_id}/thumbnail",
    ),
    data={
        "event_id": "evt-123456",
        "camera_id": "cam-789",
        "camera_name": "Front Door",
        "smart_detection_type": "person",
        "click_action": "OPEN_EVENT",
    },
    token=device_token,
    android=messaging.AndroidConfig(
        priority="high",
        notification=messaging.AndroidNotification(
            channel_id="argusai_events",
            icon="ic_notification",
            color="#4A90D9",
            default_sound=True,
            default_vibrate_timings=True,
        ),
    ),
)
```

### FCM vs APNS Differences

| Aspect | APNS | FCM |
|--------|------|-----|
| Auth | JWT with .p8 key | Service account JSON + OAuth2 |
| Connection | HTTP/2 custom client | SDK handles |
| Batching | Manual batch impl | `send_all()` built-in |
| Image | Requires mutable-content | Native image field |
| Data | Custom payload root | Separate data field |

### Dependencies

Add to requirements.txt:
- `firebase-admin>=6.4.0` - Firebase Admin SDK for FCM

[Source: docs/api/mobile-push-architecture.md#FCM-Integration]

### Error Response Handling

| Exception | Action |
|-----------|--------|
| UnregisteredError | Delete token from database, return invalid_token |
| QuotaExceededError | Log error, return rate_limited, implement backoff |
| InvalidArgumentError | Log error details, return failed (bad payload) |
| ThirdPartyAuthError | Log error, check credentials file, return auth_error |
| SenderIdMismatchError | Log error, return failed (wrong project) |
| UnavailableError | Retry with exponential backoff |

### Testing Strategy

- Unit tests mock firebase_admin.messaging module
- Test all exception types from firebase_admin.exceptions
- Test message payload formatting matches FCM spec
- Integration test requires Firebase project (deferred)

### Project Structure Notes

- FCMProvider follows same pattern as APNSProvider (P11-2.1)
- Reuse DeliveryResult and DeliveryStatus from models.py
- Add FCMConfig and FCMPayload to models.py
- Use same on_token_invalid callback pattern

### References

- [Source: docs/api/mobile-push-architecture.md#FCM-Integration]
- [Source: docs/architecture/phase-11-additions.md#FCM-Provider]
- [Source: docs/sprint-artifacts/tech-spec-epic-P11-2.md#AC-2.2.1-6]
- [Source: docs/epics-phase11.md#P11-2.2]
- [Firebase FCM Documentation](https://firebase.google.com/docs/cloud-messaging/send-message)
- [Firebase Admin Python SDK](https://firebase.google.com/docs/reference/admin/python/firebase_admin.messaging)

### Learnings from Previous Story

**From Story P11-2.1 (Status: done)**

- **New Service Created**: `APNSProvider` class at `backend/app/services/push/apns_provider.py` - use as pattern for FCMProvider
- **Package Structure**: Push services package at `backend/app/services/push/` with `__init__.py`, `models.py`, `constants.py`
- **Model Patterns**: `DeliveryResult`, `DeliveryStatus` enum already defined in models.py - reuse these
- **Error Handling Pattern**: Token invalidation callback via `on_token_invalid` parameter
- **Retry Pattern**: Exponential backoff with MAX_RETRIES=3, RETRY_BASE_DELAY_SECONDS=1
- **Testing Pattern**: 29 unit tests mocking HTTP responses - follow same pattern for FCM
- **Config Pattern**: APNS settings added to app config.py - add FCM settings similarly

[Source: docs/sprint-artifacts/P11-2-1.md#Dev-Agent-Record]

### Important Notes

- This is the second story in Epic P11-2 (Mobile Push Notifications)
- Builds on APNSProvider patterns from P11-2.1
- Future story P11-2.3 (Unified Dispatch) will integrate both providers
- Story P11-2.4 (Device Registration) will create the Device model and API
- FCM SDK is synchronous - wrap with asyncio.to_thread for async compatibility

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-2-2.context.xml

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

- All 6 acceptance criteria implemented
- Created FCMProvider with firebase-admin SDK integration
- Implemented async wrapper using asyncio.to_thread for blocking SDK calls
- Created Pydantic models: FCMConfig, FCMPayload
- Added format_event_for_fcm helper function matching APNS patterns
- Comprehensive error handling for all FCM exception types (UnregisteredError, QuotaExceededError, InvalidArgumentError, ThirdPartyAuthError, SenderIdMismatchError, UnavailableError)
- Implemented retry logic with exponential backoff for transient errors
- Token invalidation callback for unregistered devices
- Added FCM configuration to app settings (FCM_PROJECT_ID, FCM_CREDENTIALS_FILE)
- Added fcm_ready property for configuration validation
- Created 34 unit tests covering all functionality
- All 63 push notification tests passing (29 APNS + 34 FCM)
- Updated requirements.txt with firebase-admin>=6.4.0

### File List

- backend/app/services/push/fcm_provider.py (NEW) - FCM HTTP v1 client
- backend/app/services/push/models.py (MODIFIED) - Added FCMConfig, FCMPayload, format_event_for_fcm
- backend/app/services/push/__init__.py (MODIFIED) - Added FCM exports
- backend/app/core/config.py (MODIFIED) - Added FCM configuration settings
- backend/requirements.txt (MODIFIED) - Added firebase-admin>=6.4.0
- backend/tests/test_services/test_push/test_fcm_provider.py (NEW) - 34 tests

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 1.1 | 2025-12-26 | Claude | Implementation complete - all tasks done |
