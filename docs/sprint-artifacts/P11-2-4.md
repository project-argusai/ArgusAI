# Story P11-2.4: Implement Device Registration and Token Management

Status: done

## Story

As a mobile user,
I want to register my device for push notifications,
so that I receive alerts on this specific device.

## Acceptance Criteria

1. AC-2.4.1: Device model stores device_id, platform, name, push_token, user_id, last_seen
2. AC-2.4.2: POST `/api/v1/devices` registers new device
3. AC-2.4.3: GET `/api/v1/devices` lists user's devices
4. AC-2.4.4: DELETE `/api/v1/devices/{id}` revokes device
5. AC-2.4.5: Device tokens encrypted at rest using Fernet
6. AC-2.4.6: Duplicate device_id updates existing record (upsert)

## Tasks / Subtasks

- [x] Task 1: Create Device SQLAlchemy model (AC: 2.4.1, 2.4.5)
  - [x] 1.1: Create `device.py` in `backend/app/models/`
  - [x] 1.2: Define Device class with fields: id, user_id, device_id, platform, name, push_token, last_seen_at, created_at
  - [x] 1.3: Implement push_token encryption using Fernet (get_encryption_key from settings)
  - [x] 1.4: Add relationship to User model
  - [x] 1.5: Export Device from models __init__.py
- [x] Task 2: Create Alembic migration (AC: 2.4.1)
  - [x] 2.1: Generate migration for devices table
  - [x] 2.2: Add unique constraint on device_id
  - [x] 2.3: Add foreign key to users table
  - [x] 2.4: Add indexes for user_id and device_id lookups
- [x] Task 3: Create Pydantic schemas for API validation (AC: 2.4.2, 2.4.3)
  - [x] 3.1: Create `device.py` in `backend/app/schemas/`
  - [x] 3.2: Define DeviceCreate schema with device_id, platform, name, push_token
  - [x] 3.3: Define DeviceResponse schema (excludes push_token)
  - [x] 3.4: Define DeviceListResponse schema
  - [x] 3.5: Define DeviceTokenUpdate schema for token refresh
- [x] Task 4: Create Device CRUD API endpoints (AC: 2.4.2, 2.4.3, 2.4.4)
  - [x] 4.1: Create `devices.py` router in `backend/app/api/v1/`
  - [x] 4.2: Implement POST `/api/v1/devices` for registration
  - [x] 4.3: Implement GET `/api/v1/devices` for listing user's devices
  - [x] 4.4: Implement DELETE `/api/v1/devices/{device_id}` for revocation
  - [x] 4.5: Implement PUT `/api/v1/devices/{device_id}/token` for token updates
  - [x] 4.6: Register router in main.py
- [x] Task 5: Implement upsert logic for device registration (AC: 2.4.6)
  - [x] 5.1: Check for existing device by device_id on register
  - [x] 5.2: Update existing record with new token and timestamp
  - [x] 5.3: Create new record if device_id not found
  - [x] 5.4: Update last_seen_at on any successful operation
- [x] Task 6: Integrate Device model with PushDispatchService (AC: 2.4.1)
  - [x] 6.1: Update dispatch_service.py to query Device model
  - [x] 6.2: Replace mock device lookup with real database query
  - [x] 6.3: Add method to get devices by user_id
- [x] Task 7: Write unit tests (AC: all)
  - [x] 7.1: Test Device model creation and field storage
  - [x] 7.2: Test push_token encryption/decryption
  - [x] 7.3: Test API POST registration endpoint
  - [x] 7.4: Test API GET list devices endpoint
  - [x] 7.5: Test API DELETE revoke endpoint
  - [x] 7.6: Test API PUT token update endpoint
  - [x] 7.7: Test upsert logic (update on duplicate device_id)
  - [x] 7.8: Test Device query integration with dispatch service

## Dev Notes

### Architecture Patterns

This story implements the Device model and API specified in the mobile push architecture document. The Device model follows existing patterns from the codebase:

- **Encryption Pattern**: Use existing `get_encryption_key()` from `backend/app/core/config.py` for Fernet encryption, following the same pattern used for API keys in `AIProvider` model
- **Model Pattern**: Follow existing SQLAlchemy model patterns from `backend/app/models/`
- **Router Pattern**: Follow existing FastAPI router patterns from `backend/app/api/v1/`

### Device Model Schema

Based on tech spec and mobile-push-architecture.md:

```python
class Device(Base):
    __tablename__ = "devices"

    id = Column(String(36), primary_key=True, default=lambda: str(uuid4()))
    user_id = Column(String(36), ForeignKey("users.id"), nullable=False)
    device_id = Column(String(255), unique=True, nullable=False)
    platform = Column(String(20), nullable=False)  # ios, android, web
    name = Column(String(100))  # User-friendly device name
    push_token = Column(Text)  # Fernet encrypted
    last_seen_at = Column(DateTime, default=datetime.utcnow)
    created_at = Column(DateTime, default=datetime.utcnow)

    user = relationship("User", back_populates="devices")
```

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/v1/devices` | POST | Register new device |
| `/api/v1/devices` | GET | List user's devices |
| `/api/v1/devices/{device_id}` | DELETE | Remove device |
| `/api/v1/devices/{device_id}/token` | PUT | Update push token |

### Token Encryption

Push tokens must be encrypted at rest to protect against database exposure:

```python
from cryptography.fernet import Fernet
from app.core.config import get_encryption_key

def encrypt_token(token: str) -> str:
    fernet = Fernet(get_encryption_key())
    return fernet.encrypt(token.encode()).decode()

def decrypt_token(encrypted_token: str) -> str:
    fernet = Fernet(get_encryption_key())
    return fernet.decrypt(encrypted_token.encode()).decode()
```

### Project Structure Notes

Files to create/modify:

```
backend/app/models/
├── __init__.py          # Add Device export
└── device.py            # NEW: Device model

backend/app/schemas/
├── __init__.py          # Add Device schemas export
└── device.py            # NEW: Device schemas

backend/app/api/v1/
├── __init__.py          # Register devices router
└── devices.py           # NEW: Device API endpoints

backend/alembic/versions/
└── xxxx_add_devices_table.py  # NEW: Migration

backend/app/services/push/
└── dispatch_service.py  # MODIFIED: Real device queries
```

### Learnings from Previous Story

**From Story P11-2.3 (PushDispatchService):**

- PushDispatchService created at `backend/app/services/push/dispatch_service.py`
- Dispatch service has stub for device lookup that needs to be replaced
- DeliveryResult and DispatchResult models available in `models.py`
- Service routes to correct provider based on device platform
- All 95 push tests passing (29 APNS + 34 FCM + 32 Dispatch)

**Integration Point:**
The dispatch service currently has a stub for `_get_user_devices()` that returns empty list. This story completes that integration by providing the real Device model and database queries.

[Source: docs/sprint-artifacts/P11-2-3.md#Completion-Notes-List]

### Testing Strategy

Tests should cover:
1. Model tests: Device creation, encryption roundtrip
2. API tests: All CRUD operations with proper auth
3. Integration tests: Dispatch service using real Device queries

Follow existing test patterns in `backend/tests/test_services/test_push/`.

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-2.md#AC-2.4.1-6]
- [Source: docs/epics-phase11.md#P11-2.4]
- [Source: docs/api/mobile-push-architecture.md#Device-Token-Storage-Model]
- [Source: docs/api/mobile-push-architecture.md#Token-Registration-Flow]
- [Source: docs/PRD-phase11.md#FR31-FR35]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-2-4.context.xml

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

- All 6 acceptance criteria implemented
- Created Device SQLAlchemy model with Fernet encryption for push tokens
- Added User.devices relationship with cascade delete
- Created Alembic migration for devices table with proper indexes
- Created Pydantic schemas: DeviceCreate, DeviceResponse, DeviceListResponse, DeviceTokenUpdate, DeviceRegistrationResponse
- Implemented 4 API endpoints: POST, GET, DELETE, PUT /token
- Upsert logic implemented - existing device_id updates record instead of creating duplicate
- Integrated Device model with PushDispatchService._get_user_devices()
- Created 15 unit tests for Device model
- Created 5 integration tests for dispatch service device queries
- All push tests passing (dispatch service tests with device integration)

### File List

- backend/app/models/device.py (NEW) - Device SQLAlchemy model with encryption
- backend/app/models/user.py (MODIFIED) - Added devices relationship
- backend/app/models/__init__.py (MODIFIED) - Added Device export
- backend/app/schemas/device.py (NEW) - Pydantic schemas for device API
- backend/app/schemas/__init__.py (MODIFIED) - Added device schema exports
- backend/app/api/v1/devices.py (NEW) - Device CRUD API endpoints
- backend/main.py (MODIFIED) - Registered devices router
- backend/app/services/push/dispatch_service.py (MODIFIED) - Real device queries
- backend/alembic/versions/d7a2e1c4f5b3_add_devices_table.py (NEW) - Migration
- backend/tests/test_models/test_device.py (NEW) - Device model tests
- backend/tests/test_api/test_devices.py (NEW) - Device API tests
- backend/tests/test_services/test_push/test_dispatch_service.py (MODIFIED) - Added device integration tests

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 1.1 | 2025-12-26 | Claude | Implementation complete - all tasks done |
