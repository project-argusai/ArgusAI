# Story P11-2.5: Add Mobile Push Preferences (Quiet Hours)

Status: in-progress

## Story

As a user,
I want to set quiet hours for push notifications,
so that I'm not disturbed during sleep or meetings.

## Acceptance Criteria

1. AC-2.5.1: User can set quiet hours start and end time
2. AC-2.5.2: Quiet hours respect user's timezone
3. AC-2.5.3: Notifications suppressed during quiet hours
4. AC-2.5.4: Override option for critical alerts
5. AC-2.5.5: Per-device quiet hours supported

## Tasks / Subtasks

- [ ] Task 1: Extend Device model with quiet hours fields (AC: 2.5.1, 2.5.2, 2.5.5)
  - [ ] 1.1: Add `quiet_hours_enabled` (Boolean, default False) field to Device model
  - [ ] 1.2: Add `quiet_hours_start` (String, HH:MM format) field to Device model
  - [ ] 1.3: Add `quiet_hours_end` (String, HH:MM format) field to Device model
  - [ ] 1.4: Add `quiet_hours_timezone` (String, IANA format) field to Device model
  - [ ] 1.5: Add `quiet_hours_override_critical` (Boolean, default True) field to Device model
  - [ ] 1.6: Create Alembic migration for new fields

- [ ] Task 2: Extend Device API schemas (AC: 2.5.1, 2.5.5)
  - [ ] 2.1: Add quiet hours fields to DeviceCreate schema (optional)
  - [ ] 2.2: Add quiet hours fields to DeviceResponse schema
  - [ ] 2.3: Create DevicePreferencesUpdate schema for PATCH updates
  - [ ] 2.4: Add PUT `/api/v1/devices/{device_id}/preferences` endpoint

- [ ] Task 3: Implement timezone-aware quiet hours check (AC: 2.5.2, 2.5.3)
  - [ ] 3.1: Create `is_device_in_quiet_hours(device, now)` helper function in dispatch_service
  - [ ] 3.2: Handle overnight quiet hours (e.g., 22:00 - 07:00)
  - [ ] 3.3: Use pytz for timezone conversion (already a project dependency)
  - [ ] 3.4: Follow existing pattern from `is_within_quiet_hours` in push_notification_service.py

- [ ] Task 4: Update PushDispatchService to check quiet hours (AC: 2.5.3, 2.5.4)
  - [ ] 4.1: Update `_check_preferences` to implement per-device quiet hours logic (remove stub)
  - [ ] 4.2: Query device's quiet hours before dispatch
  - [ ] 4.3: Skip device if within quiet hours and not critical
  - [ ] 4.4: Respect `quiet_hours_override_critical` setting
  - [ ] 4.5: Log quiet hours skips for debugging

- [ ] Task 5: Add UI controls for quiet hours in Settings (AC: 2.5.1, 2.5.5)
  - [ ] 5.1: Create QuietHoursSettings component
  - [ ] 5.2: Add enable/disable toggle
  - [ ] 5.3: Add time picker for start/end times (HH:MM format)
  - [ ] 5.4: Add timezone selector (detect browser timezone as default)
  - [ ] 5.5: Add "Override for critical alerts" checkbox
  - [ ] 5.6: Integrate component into device preferences UI (if device settings page exists) or notification settings

- [ ] Task 6: Write unit tests (AC: all)
  - [ ] 6.1: Test quiet hours field storage in Device model
  - [ ] 6.2: Test timezone-aware quiet hours calculation
  - [ ] 6.3: Test overnight quiet hours (crossing midnight)
  - [ ] 6.4: Test critical alert override
  - [ ] 6.5: Test API preferences update endpoint
  - [ ] 6.6: Test dispatch service quiet hours integration

## Dev Notes

### Architecture Patterns

This story extends the existing quiet hours logic already present for web push subscriptions (NotificationPreference model) to per-device settings for mobile push. Key decisions:

- **Per-Device Quiet Hours**: Rather than user-level settings, we implement per-device to allow different schedules for different devices (e.g., work phone vs personal phone)
- **Reuse Existing Logic**: The `is_within_quiet_hours` function in `push_notification_service.py` already handles timezone-aware quiet hours - we'll create a similar helper for devices
- **Override Pattern**: `quiet_hours_override_critical` defaults to True, ensuring critical alerts (doorbell, package) can break through quiet hours

### Quiet Hours Algorithm

From existing push_notification_service.py implementation:

```python
def is_within_quiet_hours(start: str, end: str, tz_name: str, now: Optional[datetime] = None) -> bool:
    """Check if current time is within quiet hours."""
    user_tz = pytz.timezone(tz_name)
    current_time = (now or datetime.now(timezone.utc)).astimezone(user_tz).time()

    start_time = datetime.strptime(start, "%H:%M").time()
    end_time = datetime.strptime(end, "%H:%M").time()

    if start_time <= end_time:
        # Same day: e.g., 09:00-17:00
        return start_time <= current_time <= end_time
    else:
        # Overnight: e.g., 22:00-07:00
        return current_time >= start_time or current_time <= end_time
```

### API Endpoint Design

New endpoint for updating device preferences:

```yaml
PUT /api/v1/devices/{device_id}/preferences:
  requestBody:
    content:
      application/json:
        schema:
          type: object
          properties:
            quiet_hours_enabled:
              type: boolean
            quiet_hours_start:
              type: string
              example: "22:00"
            quiet_hours_end:
              type: string
              example: "07:00"
            quiet_hours_timezone:
              type: string
              example: "America/New_York"
            quiet_hours_override_critical:
              type: boolean
  responses:
    200:
      description: Preferences updated
```

### Project Structure Notes

Files to modify:

```
backend/app/models/
└── device.py                    # MODIFIED: Add quiet hours fields

backend/app/schemas/
└── device.py                    # MODIFIED: Add quiet hours to schemas

backend/app/api/v1/
└── devices.py                   # MODIFIED: Add preferences endpoint

backend/app/services/push/
└── dispatch_service.py          # MODIFIED: Implement quiet hours check

backend/alembic/versions/
└── xxxx_add_device_quiet_hours.py  # NEW: Migration

backend/tests/test_services/test_push/
└── test_dispatch_service.py     # MODIFIED: Add quiet hours tests

frontend/components/settings/
└── QuietHoursSettings.tsx       # NEW: Quiet hours UI component
```

### Learnings from Previous Story

**From Story P11-2.4 (Device Registration):**

- Device model created at `backend/app/models/device.py` - extend with new fields
- Device API endpoints at `backend/app/api/v1/devices.py` - add preferences endpoint
- Pydantic schemas at `backend/app/schemas/device.py` - extend with quiet hours
- Encryption pattern using Fernet is established (not needed for quiet hours - plain storage is fine)
- Dispatch service already queries Device model in `_get_user_devices()` - update `_check_preferences()`
- All 95 push tests passing - maintain test coverage
- `_check_preferences()` in dispatch_service.py is currently a stub returning `(True, True)` - this story replaces it

**Integration Points:**
- `PushDispatchService._check_preferences()` needs to check per-device quiet hours
- Web push uses NotificationPreference model (per-subscription); mobile push will use Device model fields (per-device)

[Source: docs/sprint-artifacts/P11-2-4.md#Completion-Notes-List]

### Testing Strategy

Tests should cover:
1. Device model with quiet hours fields
2. Timezone edge cases (DST transitions, UTC offsets)
3. Overnight quiet hours spanning midnight
4. Critical alert override behavior
5. API endpoint for preferences update
6. Dispatch service integration skipping devices in quiet hours

Follow existing test patterns in `backend/tests/test_services/test_push/`.

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-2.md#AC-2.5.1-5]
- [Source: docs/epics-phase11.md#P11-2.5]
- [Source: docs/architecture/phase-11-additions.md#NotificationPreferences-Extensions-P11-2.5]
- [Source: backend/app/services/push_notification_service.py#is_within_quiet_hours]
- [Source: backend/app/models/notification_preference.py]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-2-5.context.xml

### Agent Model Used

Claude Opus 4.5

### Debug Log References

### Completion Notes List

### File List

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
