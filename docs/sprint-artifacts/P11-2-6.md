# Story P11-2.6: Support Notification Thumbnails/Attachments

Status: done

## Story

As a mobile user,
I want to see event thumbnails in notifications,
so that I can quickly assess the situation without opening the app.

## Acceptance Criteria

1. AC-2.6.1: iOS notifications include image attachment via Notification Service Extension
2. AC-2.6.2: Android notifications include BigPicture style with thumbnail
3. AC-2.6.3: Thumbnail URL accessible via signed temporary link with expiration
4. AC-2.6.4: Images optimized for notification display (≤1MB, max 1024px)
5. AC-2.6.5: Fallback to text-only notification if image unavailable or fails

## Tasks / Subtasks

- [x] Task 1: Create signed URL service for secure thumbnail access (AC: 2.6.3)
  - [x] 1.1: Create `signed_url_service.py` in `backend/app/services/`
  - [x] 1.2: Implement `generate_signed_url(event_id, expiration_seconds)` using HMAC-SHA256
  - [x] 1.3: Implement `verify_signed_url(event_id, signature, timestamp)` for validation
  - [x] 1.4: Use existing `ENCRYPTION_KEY` environment variable for signing
  - [x] 1.5: Set default expiration to 60 seconds (configurable)

- [x] Task 2: Create thumbnail endpoint with signed URL validation (AC: 2.6.3, 2.6.4)
  - [x] 2.1: Add `GET /api/v1/events/{event_id}/thumbnail?signature=...&expires=...` endpoint
  - [x] 2.2: Validate signature and expiration before serving
  - [x] 2.3: Return 403 Forbidden for invalid/expired signatures
  - [x] 2.4: Stream thumbnail from disk storage efficiently
  - [x] 2.5: Set appropriate cache headers (private, no-store due to signed URLs)

- [x] Task 3: Implement image optimization for notifications (AC: 2.6.4)
  - [x] 3.1: Create `optimize_thumbnail_for_notification(image_path)` function
  - [x] 3.2: Resize images to max 1024x1024px (maintain aspect ratio)
  - [x] 3.3: Compress to ≤1MB (JPEG quality 80)
  - [x] 3.4: Use Pillow (PIL) for image processing (already a dependency)
  - [x] 3.5: Cache optimized thumbnails to avoid re-processing
  - [x] 3.6: Clean up optimized cache during retention cleanup

- [x] Task 4: Update push payload builders with signed thumbnail URLs (AC: 2.6.1, 2.6.2)
  - [x] 4.1: Update `format_event_for_apns()` to generate signed thumbnail URL
  - [x] 4.2: Update `format_event_for_fcm()` to include signed URL in `image_url` field
  - [x] 4.3: Pass base URL from settings/config for full URL construction
  - [x] 4.4: Include `mutable-content: 1` in APNS payload (already done)
  - [x] 4.5: Handle edge cases where thumbnail_path is None or file missing

- [x] Task 5: Update dispatch service for thumbnail integration (AC: 2.6.1, 2.6.2, 2.6.5)
  - [x] 5.1: Add `base_url` parameter to dispatch methods
  - [x] 5.2: Generate signed URLs before calling payload formatters
  - [x] 5.3: Verify thumbnail file exists before including URL
  - [x] 5.4: Log when falling back to text-only (thumbnail unavailable)

- [x] Task 6: Implement fallback handling (AC: 2.6.5)
  - [x] 6.1: Handle missing thumbnail files gracefully (send text-only)
  - [x] 6.2: Handle image optimization failures (use original if optimization fails)
  - [x] 6.3: Handle signed URL generation failures (send without image)
  - [x] 6.4: Add structured logging for fallback scenarios

- [x] Task 7: Write unit tests (AC: all)
  - [x] 7.1: Test signed URL generation and verification
  - [x] 7.2: Test expired signature rejection
  - [x] 7.3: Test thumbnail endpoint with valid/invalid signatures
  - [x] 7.4: Test image optimization (resize, compress, cache)
  - [x] 7.5: Test APNS payload with thumbnail URL
  - [x] 7.6: Test FCM payload with BigPicture image URL
  - [x] 7.7: Test fallback scenarios (missing thumbnail, optimization failure)

- [x] Task 8: Update documentation (AC: all)
  - [x] 8.1: Document signed URL scheme in architecture docs
  - [x] 8.2: Document iOS Notification Service Extension requirements for native app (future)
  - [x] 8.3: Add API endpoint to OpenAPI spec

## Dev Notes

### Architecture Patterns

This story adds image attachments to push notifications using platform-specific mechanisms:

**iOS (APNS):**
- Uses `mutable-content: 1` to enable Notification Service Extension
- Native app must implement `UNNotificationServiceExtension` to download image
- Thumbnail URL passed in `custom_data.thumbnail_url`
- iOS app downloads and attaches image before display
- Maximum attachment size: ~10MB, recommended <5MB

**Android (FCM):**
- Uses BigPicture notification style via `image_url` field
- FCM SDK automatically downloads and displays image
- Maximum recommended image size: 1MB
- Supported formats: JPEG, PNG, GIF

**Signed URLs:**
- Prevents unauthorized access to event thumbnails
- Short expiration (60s) limits exposure window
- HMAC-SHA256 signature using existing encryption key
- URL format: `/api/v1/events/{event_id}/thumbnail?signature={sig}&expires={timestamp}`

### Image Optimization Algorithm

```python
def optimize_thumbnail_for_notification(image_path: Path) -> Path:
    """Optimize thumbnail for push notification display."""
    MAX_DIMENSION = 1024
    MAX_FILE_SIZE = 1 * 1024 * 1024  # 1MB
    JPEG_QUALITY = 80

    with Image.open(image_path) as img:
        # Resize if needed
        if img.width > MAX_DIMENSION or img.height > MAX_DIMENSION:
            img.thumbnail((MAX_DIMENSION, MAX_DIMENSION), Image.LANCZOS)

        # Save as JPEG with compression
        optimized_path = image_path.parent / f"{image_path.stem}_notification.jpg"
        img.convert("RGB").save(optimized_path, "JPEG", quality=JPEG_QUALITY, optimize=True)

        # Re-compress if still too large
        if optimized_path.stat().st_size > MAX_FILE_SIZE:
            quality = 60
            while quality > 20 and optimized_path.stat().st_size > MAX_FILE_SIZE:
                img.save(optimized_path, "JPEG", quality=quality, optimize=True)
                quality -= 10

    return optimized_path
```

### Signed URL Generation

```python
import hashlib
import hmac
import time
from urllib.parse import urlencode

def generate_signed_url(event_id: str, base_url: str, secret_key: bytes, expiration: int = 60) -> str:
    """Generate signed URL for thumbnail access."""
    expires = int(time.time()) + expiration
    message = f"{event_id}:{expires}".encode()
    signature = hmac.new(secret_key, message, hashlib.sha256).hexdigest()

    params = urlencode({"signature": signature, "expires": expires})
    return f"{base_url}/api/v1/events/{event_id}/thumbnail?{params}"

def verify_signed_url(event_id: str, signature: str, expires: int, secret_key: bytes) -> bool:
    """Verify signed URL is valid and not expired."""
    if time.time() > expires:
        return False  # Expired

    message = f"{event_id}:{expires}".encode()
    expected = hmac.new(secret_key, message, hashlib.sha256).hexdigest()
    return hmac.compare_digest(signature, expected)
```

### Project Structure Notes

Files to create/modify:

```
backend/app/services/
├── signed_url_service.py          # NEW: Signed URL generation/verification
└── push/
    ├── models.py                  # MODIFIED: Update format_event_* functions
    └── dispatch_service.py        # MODIFIED: Integrate signed URLs

backend/app/api/v1/
└── events.py                      # MODIFIED: Add thumbnail endpoint

backend/app/services/
└── snapshot_service.py            # MODIFIED: Add optimization function

backend/tests/
├── test_services/
│   └── test_signed_url_service.py # NEW: Signed URL tests
└── test_api/
    └── test_events.py             # MODIFIED: Add thumbnail endpoint tests
```

### Learnings from Previous Story

**From Story P11-2.5 (Quiet Hours):**

- Device model extended with quiet hours fields at `backend/app/models/device.py`
- `_check_preferences()` in dispatch_service.py now implements per-device quiet hours
- All 95 push tests passing - maintain test coverage
- Dispatch service already handles Device queries via `_get_user_devices()`

**From Story P11-2.4 (Device Registration):**

- Device model stores `push_token` with Fernet encryption
- Upsert pattern established for device registration
- Push token encryption/decryption helpers available

**Integration Points:**
- `format_event_for_apns()` and `format_event_for_fcm()` already accept `thumbnail_url` parameter
- `APNSPayload` already has `mutable_content=True` enabled
- `FCMPayload` has `image_url` field ready for use
- Need to pass actual signed URLs from dispatch service to payload formatters

[Source: docs/sprint-artifacts/P11-2-5.md#Learnings-from-Previous-Story]
[Source: docs/sprint-artifacts/P11-2-4.md#Completion-Notes-List]

### Testing Strategy

Tests should cover:
1. Signed URL service: generation, verification, expiration
2. Thumbnail endpoint: valid access, expired rejection, invalid signature
3. Image optimization: resize, compress, cache hit/miss
4. Payload integration: APNS with thumbnail, FCM with BigPicture
5. Fallback handling: missing thumbnail, optimization failure
6. End-to-end: dispatch with thumbnail attachment

Follow existing test patterns in `backend/tests/test_services/test_push/`.

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-2.md#AC-2.6.1-5]
- [Source: docs/epics-phase11.md#P11-2.6]
- [Source: docs/architecture/phase-11-additions.md#Push-Notification-Architecture]
- [Source: backend/app/services/push/models.py#format_event_for_apns]
- [Source: backend/app/services/push/models.py#format_event_for_fcm]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-2-6.context.xml

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- Implemented SignedURLService with HMAC-SHA256 signatures using ENCRYPTION_KEY
- Added GET /api/v1/events/{event_id}/thumbnail endpoint with signature validation
- Implemented optimize_thumbnail_for_notification() with caching and adaptive JPEG quality
- Updated PushDispatchService.dispatch_event() with thumbnail_path and base_url parameters
- Added _generate_thumbnail_url() helper with file verification and fallback handling
- Created 21 new tests: 15 for signed URL service, 6 for dispatch thumbnail integration
- All 114 push tests passing (up from 108 before)
- Updated Phase 11 architecture docs with thumbnail attachment flow diagram

### File List

**New Files:**
- backend/app/services/signed_url_service.py
- backend/tests/test_services/test_signed_url_service.py

**Modified Files:**
- backend/app/api/v1/events.py (added signed thumbnail endpoint)
- backend/app/services/push/dispatch_service.py (added thumbnail URL generation)
- backend/app/services/snapshot_service.py (added optimization function)
- backend/tests/test_api/test_events.py (added thumbnail endpoint tests)
- backend/tests/test_services/test_push/test_dispatch_service.py (added thumbnail URL tests)
- docs/architecture/phase-11-additions.md (added P11-2.6 documentation)

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tasks done |
