# Story P11-3.2: Add Entity Match Context to Provider

Status: review

## Story

As a system,
I want to include known entity information in AI prompts,
so that the AI can identify recognized people and vehicles.

## Acceptance Criteria

1. AC-3.2.1: Entity context includes matched entity details
2. AC-3.2.2: Similar entities (by embedding) suggested
3. AC-3.2.3: Entity names and attributes included in prompt
4. AC-3.2.4: Recent entity sightings provide temporal context
5. AC-3.2.5: Context size limited to prevent prompt overflow

## Tasks / Subtasks

- [x] Task 1: Implement `_get_entity_context` method (AC: 3.2.1, 3.2.3)
  - [x] 1.1: Add `_get_entity_context(entity_id: str)` method to MCPContextProvider
  - [x] 1.2: Query RecognizedEntity by ID from database
  - [x] 1.3: Return EntityContext with name, entity_type, and attributes
  - [x] 1.4: Handle entity not found gracefully (return None)

- [x] Task 2: Add recent sighting context (AC: 3.2.4)
  - [x] 2.1: Use occurrence_count from RecognizedEntity directly (no join needed)
  - [x] 2.2: Include `sighting_count` in EntityContext
  - [x] 2.3: Include `last_seen` timestamp from RecognizedEntity.last_seen_at
  - [x] 2.4: Format "last seen" as human-readable time via _format_time_ago()

- [x] Task 3: Implement similar entity suggestions (AC: 3.2.2)
  - [x] 3.1: Add `_get_similar_entities(entity_id: str)` helper method
  - [x] 3.2: Query entities with same entity_type
  - [x] 3.3: For vehicles, match by vehicle_signature pattern (same color)
  - [x] 3.4: Return top 3 similar entities by occurrence_count
  - [x] 3.5: Add similar_entities field to EntityContext dataclass

- [x] Task 4: Add context size limiting (AC: 3.2.5)
  - [x] 4.1: Define MAX_ENTITY_CONTEXT_CHARS constant (500 chars)
  - [x] 4.2: Truncate entity attributes if context exceeds limit
  - [x] 4.3: Prioritize name, type, and sighting count over attributes
  - [x] 4.4: Log debug when truncation occurs

- [x] Task 5: Integrate entity context into get_context flow (AC: 3.2.1)
  - [x] 5.1: Update `get_context()` to call `_get_entity_context()` when entity_id provided
  - [x] 5.2: Add `_safe_get_entity_context()` wrapper for fail-open behavior
  - [x] 5.3: Include entity context in AIContext response
  - [x] 5.4: Update logging to track entity context gathering

- [x] Task 6: Update format_for_prompt for entity context (AC: 3.2.3)
  - [x] 6.1: Format entity name and type (verified existing code works)
  - [x] 6.2: Include vehicle-specific attributes (color, make, model)
  - [x] 6.3: Add sighting history text (e.g., "Seen 12 times, last seen 2 hours ago")
  - [x] 6.4: Include similar entity hints if available

- [x] Task 7: Write unit tests (AC: all)
  - [x] 7.1: Test entity context gathering with valid entity
  - [x] 7.2: Test entity not found returns None
  - [x] 7.3: Test sighting count calculation
  - [x] 7.4: Test similar entities for vehicle type
  - [x] 7.5: Test context size limiting/truncation
  - [x] 7.6: Test fail-open behavior on database error
  - [x] 7.7: Test prompt formatting with full entity context
  - [x] 7.8: All 42 tests pass (17 new entity tests added)

## Dev Notes

### Architecture Patterns

This story extends the MCPContextProvider created in P11-3.1 to include entity context. The entity context provides information about recognized visitors (people, vehicles) to help the AI identify familiar faces and cars.

**Key Design Decisions:**
- Entity context is only included when `entity_id` is provided to `get_context()`
- Similar entities help AI recognize recurring visitors even without exact match
- Context size limiting prevents prompt token overflow
- Fail-open design: entity lookup failures don't break AI descriptions

**Integration Points:**
- Uses `RecognizedEntity` model from `backend/app/models/recognized_entity.py`
- Uses `EntityEvent` model for sighting history queries
- Extends existing `EntityContext` dataclass (already defined in mcp_context.py)

### Data Model Reference

**RecognizedEntity Model (from backend/app/models/recognized_entity.py):**
- `id`: UUID primary key
- `entity_type`: 'person', 'vehicle', or 'unknown'
- `name`: User-assigned name (nullable)
- `first_seen_at`: Timestamp of first occurrence
- `last_seen_at`: Timestamp of most recent occurrence
- `occurrence_count`: Number of times seen
- `entity_metadata`: JSON object for additional data
- `vehicle_color`, `vehicle_make`, `vehicle_model`: Vehicle-specific fields
- `vehicle_signature`: Normalized matching signature (e.g., 'white-toyota-camry')

**EntityEvent Model:**
- `entity_id`: FK to RecognizedEntity
- `event_id`: FK to Event
- `similarity_score`: Cosine similarity (0.0-1.0)
- `created_at`: When link was created

### Query Strategy

```python
# Entity context query
async def _get_entity_context(self, db: Session, entity_id: str) -> Optional[EntityContext]:
    entity = db.query(RecognizedEntity).filter(RecognizedEntity.id == entity_id).first()
    if not entity:
        return None

    # Build attributes dict from entity fields
    attributes = {}
    if entity.vehicle_color:
        attributes['color'] = entity.vehicle_color
    if entity.vehicle_make:
        attributes['make'] = entity.vehicle_make
    if entity.vehicle_model:
        attributes['model'] = entity.vehicle_model

    return EntityContext(
        entity_id=entity.id,
        name=entity.name or entity.display_name,
        entity_type=entity.entity_type,
        attributes=attributes,
        last_seen=entity.last_seen_at,
        sighting_count=entity.occurrence_count,
    )
```

### Project Structure Notes

Files to modify:
```
backend/app/services/
└── mcp_context.py          # MODIFY: Add entity context methods

backend/tests/test_services/
└── test_mcp_context.py     # MODIFY: Add entity context tests
```

No new files required - extending existing MCPContextProvider.

### Testing Strategy

Follow existing test patterns in `test_mcp_context.py`:
- Mock RecognizedEntity queries
- Test entity lookup with valid/invalid IDs
- Test attribute extraction for vehicles
- Test sighting count queries
- Test fail-open behavior with database errors

### Learnings from Previous Story

**From Story P11-3.1 (MCPContextProvider MVP) - Status: done**

- **Singleton pattern**: Use `get_mcp_context_provider()` and `reset_mcp_context_provider()` - continue this pattern
- **Fail-open design**: Wrap context gathering in `_safe_*` methods that catch exceptions and return None
- **Logging pattern**: Use structured logging with `event_type`, `camera_id`, `duration_ms` extras
- **Test patterns**: Mock database queries with `MagicMock`, test accuracy calculations separately
- **EntityContext dataclass**: Already defined with placeholder fields - now implement actual population

**Files created in P11-3.1:**
- `backend/app/services/mcp_context.py` - Contains EntityContext dataclass (use this, don't recreate)
- `backend/tests/test_services/test_mcp_context.py` - Contains entity formatting tests (extend these)

**Integration note**: The format_for_prompt() method already handles EntityContext - verify it works with real data.

[Source: docs/sprint-artifacts/P11-3-1.md#Completion-Notes-List]

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-3.md#Entity-Context-Query]
- [Source: docs/sprint-artifacts/tech-spec-epic-P11-3.md#Acceptance-Criteria]
- [Source: docs/epics-phase11.md#P11-3.2]
- [Source: docs/architecture/phase-11-additions.md#MCP-Context-Provider]
- [Source: backend/app/models/recognized_entity.py]
- [Source: backend/app/services/mcp_context.py]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-3-2.context.xml

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- Implemented `_get_entity_context()` method that queries RecognizedEntity by ID
- Added `_get_similar_entities()` method to find similar entities by type and signature
- Added `_safe_get_entity_context()` wrapper for fail-open error handling
- Updated `get_context()` to include entity context when entity_id is provided
- Added `_format_entity_context()` method for prompt formatting with size limiting
- Added `_format_time_ago()` helper for human-readable "last seen" timestamps
- Updated EntityContext dataclass with `similar_entities` field
- Added MAX_ENTITY_CONTEXT_CHARS (500) and MAX_SIMILAR_ENTITIES (3) constants
- Added 17 new test cases covering all acceptance criteria
- All 42 tests in test_mcp_context.py pass
- Full regression suite: 3395 tests pass

### File List

**Modified:**
- backend/app/services/mcp_context.py - Added entity context methods
- backend/tests/test_services/test_mcp_context.py - Added entity context tests

**Added:**
- docs/sprint-artifacts/P11-3-2.md - Story file
- docs/sprint-artifacts/P11-3-2.context.xml - Story context file

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tasks done, all tests passing |
