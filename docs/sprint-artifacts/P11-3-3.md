# Story P11-3.3: Integrate Camera and Time Pattern Context

Status: done

## Story

As a system,
I want camera location and time patterns in AI prompts,
so that the AI understands typical activity for context.

## Acceptance Criteria

1. AC-3.3.1: Camera context includes location hints
2. AC-3.3.2: Typical activity patterns for camera included
3. AC-3.3.3: Time-of-day activity levels provided
4. AC-3.3.4: Unusual timing flagged in context
5. AC-3.3.5: False positive patterns shared

## Tasks / Subtasks

- [x] Task 1: Implement `_get_camera_context` method (AC: 3.3.1, 3.3.2, 3.3.5)
  - [x] 1.1: Add `_get_camera_context(camera_id: str)` method to MCPContextProvider
  - [x] 1.2: Query Camera model to get name (as location_hint)
  - [x] 1.3: Query recent events to find typical_objects (top 3 smart_detection_type)
  - [x] 1.4: Extract false_positive_patterns from negative feedback corrections
  - [x] 1.5: Add `_safe_get_camera_context()` wrapper for fail-open behavior

- [x] Task 2: Implement `_get_time_pattern_context` method (AC: 3.3.3, 3.3.4)
  - [x] 2.1: Add `_get_time_pattern_context(camera_id: str, event_time: datetime)` method
  - [x] 2.2: Query events from last 30 days for this camera
  - [x] 2.3: Calculate average event count per hour
  - [x] 2.4: Determine activity level (low/medium/high) based on average
  - [x] 2.5: Flag is_unusual for activity during low-activity hours (late night/early morning)
  - [x] 2.6: Add `_safe_get_time_pattern_context()` wrapper for fail-open behavior

- [x] Task 3: Integrate camera and time context into get_context flow (AC: all)
  - [x] 3.1: Update `get_context()` to call camera and time context methods
  - [x] 3.2: Include camera context in AIContext response
  - [x] 3.3: Include time_pattern context in AIContext response
  - [x] 3.4: Update logging to track camera/time context gathering

- [x] Task 4: Update format_for_prompt for camera/time context (AC: 3.3.1, 3.3.4)
  - [x] 4.1: Expand camera context formatting (location, typical objects)
  - [x] 4.2: Add false positive patterns to prompt
  - [x] 4.3: Expand time pattern formatting (activity level, unusual flag)

- [x] Task 5: Write unit tests (AC: all)
  - [x] 5.1: Test camera context gathering with valid camera
  - [x] 5.2: Test camera not found returns None
  - [x] 5.3: Test typical objects extraction from events
  - [x] 5.4: Test false positive pattern extraction
  - [x] 5.5: Test time pattern calculation
  - [x] 5.6: Test is_unusual flag for late night activity
  - [x] 5.7: Test fail-open behavior on database error
  - [x] 5.8: Test prompt formatting with full camera/time context

## Dev Notes

### Architecture Patterns

This story adds camera and time pattern context to MCPContextProvider, completing the four context components (feedback, entity, camera, time).

**Key Design Decisions:**
- Camera name is used as location_hint (e.g., "Front Door", "Driveway")
- Typical objects derived from smart_detection_type in recent events
- False positive patterns extracted from negative feedback corrections
- Activity levels: low (<1 event/day avg), medium (1-5), high (>5)
- Late night hours (22:00-06:00) during low activity are flagged as unusual

### Implementation Details

**Camera Context (`_get_camera_context`):**
- Queries Camera model to get camera name as location_hint
- Queries recent events (last 30 days) to find typical detection types
- Uses Counter to count frequency of smart_detection_type
- Returns top 3 most common detection types as typical_objects
- Extracts false positive patterns from negative feedback corrections
- Patterns are extracted using `_extract_common_patterns()` method

**Time Pattern Context (`_get_time_pattern_context`):**
- Uses SQLAlchemy `func.count` and `extract('hour', ...)` for hourly aggregation
- Calculates average events per day at current hour over 30 days
- Activity levels: low (<1/day), medium (1-5/day), high (>5/day)
- Unusual flag set when: late night (22:00-06:00) AND low activity

**Prompt Formatting:**
- `_format_camera_context()` formats location, typical objects, and false positives
- `_format_time_pattern_context()` formats activity level and unusual flag
- Example output:
  ```
  Camera location: Front Door
  Commonly detected at this camera: person, vehicle, package
  Common false positive patterns: shadow, tree
  Time of day: 03:00 (typical activity: low)
  ⚠️ Note: This is unusual activity for this time of day
  ```

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-3.md#Time-Pattern-Query]
- [Source: docs/epics-phase11.md#P11-3.3]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-3-2.md (prior story learnings)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- Implemented `_get_camera_context()` method that queries Camera and Event models
- Implemented `_get_time_pattern_context()` method with hourly event analysis
- Added `_safe_get_camera_context()` wrapper for fail-open error handling
- Added `_safe_get_time_pattern_context()` wrapper for fail-open error handling
- Updated `get_context()` to include camera and time pattern context
- Added `_format_camera_context()` method for camera prompt formatting
- Added `_format_time_pattern_context()` method for time pattern prompt formatting
- Added class constants: EVENT_HISTORY_DAYS (30), MAX_TYPICAL_OBJECTS (3), MAX_FALSE_POSITIVES (3)
- Added 21 new test cases covering all acceptance criteria:
  - TestCameraContextGathering: 6 tests
  - TestTimePatternContextGathering: 6 tests
  - TestCameraContextFormatting: 4 tests
  - TestTimePatternContextFormatting: 3 tests
  - TestCameraAndTimeContextFailOpen: 3 tests (includes partial context test)
- All 63 tests in test_mcp_context.py pass

### File List

**Modified:**
- backend/app/services/mcp_context.py - Added camera and time pattern context methods
- backend/tests/test_services/test_mcp_context.py - Added camera and time pattern tests

**Added:**
- docs/sprint-artifacts/P11-3-3.md - Story file

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tasks done, all tests passing |
