# Story P11-3.4: Add Context Caching and Performance Metrics

Status: done

## Story

As a system,
I want context gathering to be fast and monitored,
So that it doesn't slow down event processing.

## Acceptance Criteria

1. AC-3.4.1: Context cached with 60-second TTL
2. AC-3.4.2: Cache key based on camera + time window
3. AC-3.4.3: Context queries complete within 50ms (p95)
4. AC-3.4.4: Metrics track context gathering latency
5. AC-3.4.5: Cache hit/miss ratios monitored

## Tasks / Subtasks

- [x] Task 1: Implement in-memory context cache (AC: 3.4.1, 3.4.2)
  - [x] 1.1: Create CachedContext dataclass with timestamp
  - [x] 1.2: Add in-memory cache dict to MCPContextProvider
  - [x] 1.3: Generate cache key from camera_id + hour
  - [x] 1.4: Implement TTL check in is_expired() method
  - [x] 1.5: Add cache lookup at start of get_context()

- [x] Task 2: Add cache management (AC: 3.4.1)
  - [x] 2.1: Return cached context if not expired
  - [x] 2.2: Store new context in cache after gathering
  - [x] 2.3: Add cache cleanup for expired entries
  - [x] 2.4: Add clear_cache() method for testing

- [x] Task 3: Add Prometheus metrics (AC: 3.4.4, 3.4.5)
  - [x] 3.1: Add context_latency_seconds histogram
  - [x] 3.2: Add cache_hits_total counter
  - [x] 3.3: Add cache_misses_total counter
  - [x] 3.4: Record metrics in get_context()

- [x] Task 4: Add performance logging (AC: 3.4.3, 3.4.4)
  - [x] 4.1: Log cache hit/miss events
  - [x] 4.2: Log context gathering duration
  - [x] 4.3: Add warning log if duration exceeds 50ms

- [x] Task 5: Write unit tests (AC: all)
  - [x] 5.1: Test cache stores context
  - [x] 5.2: Test cache returns cached context before TTL
  - [x] 5.3: Test cache expires after TTL
  - [x] 5.4: Test cache key includes camera and hour
  - [x] 5.5: Test metrics are recorded
  - [x] 5.6: Test clear_cache() resets cache
  - [x] 5.7: Test entity context is not cached (fetched on each request)

## Dev Notes

### Architecture Patterns

This story adds caching and observability to MCPContextProvider, completing Epic P11-3.

**Key Design Decisions:**
- In-memory dict cache (simple, no external dependencies)
- TTL of 60 seconds (configurable via CACHE_TTL_SECONDS constant)
- Cache key: `{camera_id}:{hour}` (hour from event_time)
- Entity context is NOT cached (request-specific, depends on entity_id)
- Prometheus counters and histograms for observability

### Implementation Details

**CachedContext Dataclass:**
```python
@dataclass
class CachedContext:
    context: AIContext
    created_at: datetime

    def is_expired(self, ttl_seconds: int = 60) -> bool:
        now = datetime.now(timezone.utc)
        created = self.created_at
        if created.tzinfo is None:
            created = created.replace(tzinfo=timezone.utc)
        return (now - created).total_seconds() > ttl_seconds
```

**Cache Key Generation:**
```python
def _get_cache_key(self, camera_id: str, event_time: datetime) -> str:
    return f"{camera_id}:{event_time.hour}"
```

**Prometheus Metrics:**
- `argusai_mcp_context_latency_seconds{cached}` - Histogram with buckets from 5ms to 1s
- `argusai_mcp_cache_hits_total` - Counter for cache hits
- `argusai_mcp_cache_misses_total` - Counter for cache misses

**Performance Logging:**
- Debug logs for cache hits/misses with cache key
- Info logs for context gathering with duration
- Warning logs when duration exceeds 50ms threshold

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-P11-3.md#CachedContext]
- [Source: docs/sprint-artifacts/tech-spec-epic-P11-3.md#Non-Functional-Requirements]
- [Source: docs/epics-phase11.md#P11-3.4]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/P11-3-3.md (prior story learnings)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- Added CachedContext dataclass with is_expired() method
- Added in-memory cache dict (_cache) to MCPContextProvider
- Added _get_cache_key() method for generating cache keys
- Added clear_cache() method for testing and manual invalidation
- Updated get_context() to check cache first, return cached on hit
- Entity context is not cached (request-specific)
- Added Prometheus metrics:
  - MCP_CONTEXT_LATENCY histogram
  - MCP_CACHE_HITS counter
  - MCP_CACHE_MISSES counter
- Added slow query warning log (>50ms threshold)
- Added class constants: CACHE_TTL_SECONDS (60), SLOW_QUERY_THRESHOLD_MS (50)
- Fixed Counter import conflict (prometheus Counter vs collections Counter)
- Added 13 new test cases covering caching and metrics:
  - TestCachedContext: 3 tests
  - TestContextCaching: 6 tests
  - TestContextMetrics: 3 tests
  - TestContextCachingWithEntity: 1 test
- All 76 tests in test_mcp_context.py pass

### File List

**Modified:**
- backend/app/services/mcp_context.py - Added caching and metrics
- backend/tests/test_services/test_mcp_context.py - Added caching and metrics tests

**Added:**
- docs/sprint-artifacts/P11-3-4.md - Story file

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-26 | Claude | Initial story creation |
| 2.0 | 2025-12-26 | Claude | Implementation complete - all tasks done, all tests passing |
