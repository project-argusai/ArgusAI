<?xml version="1.0" encoding="UTF-8"?>
<!-- Story Context XML for P4-8.2: Person Matching -->
<!-- Generated: 2025-12-13 -->
<!-- Epic: P4-8 Person & Vehicle Recognition (Growth) -->

<story-context story-key="p4-8-2-person-matching">
  <metadata>
    <epic>P4-8</epic>
    <phase>4</phase>
    <story-number>2</story-number>
    <title>Person Matching</title>
    <generated>2025-12-13</generated>
  </metadata>

  <acceptance-criteria>
    <criterion id="1">Create PersonMatchingService that matches face embeddings to known persons using cosine similarity</criterion>
    <criterion id="2">Handle multiple faces in single frame - each face can match to different person</criterion>
    <criterion id="3">Link FaceEmbedding.entity_id when match found, create EntityEvent link</criterion>
    <criterion id="4">Optionally create new RecognizedEntity (type='person') when no match found</criterion>
    <criterion id="5">Handle appearance changes - update reference embedding on high-confidence matches</criterion>
    <criterion id="6">Integrate into event pipeline after face embedding storage (Step 13)</criterion>
    <criterion id="7">Add person-focused API endpoints (GET/PUT /api/v1/context/persons)</criterion>
    <criterion id="8">Comprehensive tests for matching, no-match, multi-face, threshold edge cases</criterion>
  </acceptance-criteria>

  <dependencies>
    <dependency story="P4-8.1" status="done">
      <description>Face Embedding Storage - FaceDetectionService, FaceEmbeddingService, FaceEmbedding model</description>
      <files>
        <file>backend/app/services/face_detection_service.py</file>
        <file>backend/app/services/face_embedding_service.py</file>
        <file>backend/app/models/face_embedding.py</file>
      </files>
    </dependency>
    <dependency story="P4-3.3" status="done">
      <description>Recurring Visitor Detection - EntityService, RecognizedEntity model</description>
      <files>
        <file>backend/app/services/entity_service.py</file>
        <file>backend/app/models/recognized_entity.py</file>
      </files>
    </dependency>
    <dependency story="P4-3.2" status="done">
      <description>Similarity Search - batch_cosine_similarity function</description>
      <files>
        <file>backend/app/services/similarity_service.py</file>
      </files>
    </dependency>
  </dependencies>

  <codebase-references>
    <reference name="FaceEmbedding Model" priority="critical">
      <file>backend/app/models/face_embedding.py</file>
      <reason>Main model to link to persons. Has entity_id FK to recognized_entities (SET NULL).</reason>
      <key-fields>
        <field name="entity_id" type="String FK" nullable="true">Links face to RecognizedEntity</field>
        <field name="embedding" type="Text (JSON)">512-dim CLIP embedding for similarity comparison</field>
        <field name="confidence" type="Float">Face detection confidence (0.0-1.0)</field>
        <field name="model_version" type="String">Embedding model version for compatibility</field>
      </key-fields>
    </reference>

    <reference name="RecognizedEntity Model" priority="critical">
      <file>backend/app/models/recognized_entity.py</file>
      <reason>Person entities with entity_type='person'. Has reference_embedding for matching.</reason>
      <key-fields>
        <field name="entity_type" type="String(50)">Type: 'person', 'vehicle', 'unknown'</field>
        <field name="name" type="String(255)" nullable="true">User-assigned name (e.g., "John")</field>
        <field name="reference_embedding" type="Text">512-dim CLIP embedding for similarity matching</field>
        <field name="occurrence_count" type="Integer">Times this entity has been seen</field>
        <field name="first_seen_at" type="DateTime">First occurrence timestamp</field>
        <field name="last_seen_at" type="DateTime">Most recent occurrence timestamp</field>
      </key-fields>
    </reference>

    <reference name="FaceEmbeddingService" priority="critical">
      <file>backend/app/services/face_embedding_service.py</file>
      <reason>Service that creates face embeddings. PersonMatchingService integrates after this.</reason>
      <key-methods>
        <method name="process_event_faces">Detects faces, generates embeddings, stores FaceEmbedding records</method>
        <method name="get_face_embeddings">Get face embeddings for an event</method>
        <method name="get_face_embedding_vector">Get raw embedding vector for a face</method>
      </key-methods>
      <singleton>get_face_embedding_service()</singleton>
    </reference>

    <reference name="EntityService" priority="high">
      <file>backend/app/services/entity_service.py</file>
      <reason>Existing entity matching service. PersonMatchingService follows similar patterns.</reason>
      <key-patterns>
        <pattern name="Entity Cache">_entity_cache dict for fast embedding lookup</pattern>
        <pattern name="match_or_create_entity">Create entity if no match (threshold-based)</pattern>
        <pattern name="EntityEvent Link">Creates EntityEvent junction record on match</pattern>
        <pattern name="Cache Invalidation">_invalidate_cache() on entity changes</pattern>
      </key-patterns>
      <singleton>get_entity_service()</singleton>
    </reference>

    <reference name="Similarity Functions" priority="high">
      <file>backend/app/services/similarity_service.py</file>
      <reason>Reusable cosine similarity functions for face-to-person matching.</reason>
      <key-functions>
        <function name="cosine_similarity(vec1, vec2)">Single vector pair similarity</function>
        <function name="batch_cosine_similarity(query, candidates)">Efficient batch comparison using numpy</function>
      </key-functions>
    </reference>

    <reference name="Event Processor Pipeline" priority="high">
      <file>backend/app/services/event_processor.py</file>
      <reason>Integration point. Step 12 is face processing, add Step 13 for person matching.</reason>
      <key-sections>
        <section name="_process_faces">Step 12: async face embedding generation</section>
        <section name="face_recognition_enabled">Privacy check before face processing</section>
      </key-sections>
    </reference>

    <reference name="Context API" priority="medium">
      <file>backend/app/api/v1/context.py</file>
      <reason>Add person-focused endpoints here alongside existing entity endpoints.</reason>
      <existing-endpoints>
        <endpoint method="GET" path="/api/v1/context/faces/{event_id}">Face embeddings for event</endpoint>
        <endpoint method="GET" path="/api/v1/entities">List all entities</endpoint>
        <endpoint method="PUT" path="/api/v1/entities/{id}">Update entity name</endpoint>
      </existing-endpoints>
    </reference>

    <reference name="System Settings Schema" priority="medium">
      <file>backend/app/schemas/system.py</file>
      <reason>Add person matching settings (threshold, auto_create).</reason>
      <existing-fields>
        <field name="face_recognition_enabled">Controls face processing (default: false)</field>
      </existing-fields>
    </reference>

    <reference name="EntityEvent Junction" priority="medium">
      <file>backend/app/models/recognized_entity.py</file>
      <reason>Junction table for linking entities to events with similarity scores.</reason>
      <key-fields>
        <field name="entity_id">FK to recognized_entities (CASCADE)</field>
        <field name="event_id">FK to events (CASCADE)</field>
        <field name="similarity_score">Match confidence (0.0-1.0)</field>
      </key-fields>
    </reference>
  </codebase-references>

  <implementation-approach>
    <step n="1" goal="Create PersonMatchingService">
      <task>Create backend/app/services/person_matching_service.py with PersonMatchingService class</task>
      <task>Add PersonMatchResult dataclass with face_embedding_id, person_id, name, similarity, is_new, is_appearance_update</task>
      <task>Implement _load_person_cache() to cache only entity_type='person' embeddings</task>
      <task>Implement match_single_face() - compare face embedding to person embeddings</task>
      <task>Implement match_faces_to_persons() - process multiple faces from an event</task>
      <task>Add singleton get_person_matching_service()</task>
    </step>

    <step n="2" goal="Implement Face-to-Person Linking">
      <task>In match_single_face(), when match found: update FaceEmbedding.entity_id</task>
      <task>Create EntityEvent link with similarity score</task>
      <task>Update person's last_seen_at and occurrence_count</task>
      <task>Handle duplicate faces in same event (same person appearing twice)</task>
    </step>

    <step n="3" goal="Implement New Person Creation">
      <task>When no match and auto_create_persons=true, create new RecognizedEntity</task>
      <task>Set entity_type='person', name=None (user names later)</task>
      <task>Use face embedding as reference_embedding</task>
      <task>Add to person cache after creation</task>
    </step>

    <step n="4" goal="Add Appearance Update Logic">
      <task>When match confidence > 0.90 but embedding differs by threshold</task>
      <task>Optionally update reference_embedding (weighted average or replace)</task>
      <task>Log appearance updates for debugging</task>
      <task>Set is_appearance_update=true in result</task>
    </step>

    <step n="5" goal="Add Settings">
      <task>Add person_match_threshold (default 0.70) to SystemSettingsUpdate schema</task>
      <task>Add auto_create_persons (default true) setting</task>
      <task>Add update_appearance_on_high_match (default true) setting</task>
      <task>Add to no_prefix_fields in system.py</task>
    </step>

    <step n="6" goal="Integrate into Pipeline">
      <task>Add Step 13 in event_processor.py after face processing</task>
      <task>Get face_embedding_ids from Step 12</task>
      <task>Call PersonMatchingService.match_faces_to_persons()</task>
      <task>Log matched person names</task>
      <task>Run async (fire-and-forget after event stored)</task>
    </step>

    <step n="7" goal="Add API Endpoints">
      <task>GET /api/v1/context/persons - list entities where entity_type='person'</task>
      <task>Include face_count from FaceEmbedding table in response</task>
      <task>GET /api/v1/context/persons/{id} - person details with recent face matches</task>
      <task>PUT /api/v1/context/persons/{id} - update person name</task>
    </step>

    <step n="8" goal="Write Tests">
      <task>Create backend/tests/test_services/test_person_matching_service.py</task>
      <task>Test match_single_face with known person, unknown face, edge threshold</task>
      <task>Test match_faces_to_persons with multiple faces</task>
      <task>Test appearance update logic</task>
      <task>Test auto_create_persons setting</task>
      <task>Create backend/tests/test_api/test_context_persons.py for API tests</task>
    </step>
  </implementation-approach>

  <testing-strategy>
    <unit-tests>
      <test-file>backend/tests/test_services/test_person_matching_service.py</test-file>
      <test-cases>
        <case>test_match_single_face_known_person</case>
        <case>test_match_single_face_unknown</case>
        <case>test_match_single_face_below_threshold</case>
        <case>test_match_single_face_above_threshold</case>
        <case>test_match_faces_to_persons_multiple</case>
        <case>test_match_faces_same_person_twice</case>
        <case>test_auto_create_persons_enabled</case>
        <case>test_auto_create_persons_disabled</case>
        <case>test_appearance_update_triggered</case>
        <case>test_person_cache_loading</case>
        <case>test_entity_event_link_created</case>
      </test-cases>
    </unit-tests>

    <api-tests>
      <test-file>backend/tests/test_api/test_context_persons.py</test-file>
      <test-cases>
        <case>test_get_persons_list</case>
        <case>test_get_persons_empty</case>
        <case>test_get_person_detail</case>
        <case>test_get_person_not_found</case>
        <case>test_update_person_name</case>
      </test-cases>
    </api-tests>
  </testing-strategy>

  <learnings-from-previous>
    <learning source="p4-8-1-face-embedding-storage">
      <pattern name="Singleton Service">Use get_person_matching_service() pattern</pattern>
      <pattern name="Async Fire-and-Forget">Use asyncio.create_task() for non-blocking processing</pattern>
      <pattern name="Settings Access">Add to no_prefix_fields for direct service access</pattern>
      <pattern name="FaceEmbedding.entity_id">Already has FK to recognized_entities - just update it</pattern>
    </learning>
    <learning source="p4-3-3-recurring-visitor-detection">
      <pattern name="Entity Cache">Cache embeddings in memory for fast matching</pattern>
      <pattern name="EntityEvent Link">Create link with similarity_score on match</pattern>
      <pattern name="Occurrence Tracking">Update last_seen_at and occurrence_count</pattern>
    </learning>
  </learnings-from-previous>

  <file-manifest>
    <new-files>
      <file>backend/app/services/person_matching_service.py</file>
      <file>backend/tests/test_services/test_person_matching_service.py</file>
      <file>backend/tests/test_api/test_context_persons.py</file>
    </new-files>
    <modified-files>
      <file>backend/app/schemas/system.py</file>
      <file>backend/app/api/v1/system.py</file>
      <file>backend/app/api/v1/context.py</file>
      <file>backend/app/services/event_processor.py</file>
    </modified-files>
  </file-manifest>
</story-context>
