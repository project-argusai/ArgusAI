<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>P5-5</epicId>
    <storyId>P5-5.4</storyId>
    <title>Implement Multiple Schedule Time Ranges</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p5-5-4-implement-multiple-schedule-time-ranges.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user configuring detection schedules</asA>
    <iWant>to define multiple active time ranges per day (e.g., 6-9am AND 6-11pm)</iWant>
    <soThat>I can enable motion detection during my morning and evening routines without it running during work hours</soThat>
    <tasks>
      <task id="1" status="pending">Update TypeScript types for multiple time ranges (AC: 1, 3)</task>
      <task id="2" status="pending">Update ScheduleManager backend service (AC: 4)</task>
      <task id="3" status="pending">Build MultiTimeRangePicker UI component (AC: 2)</task>
      <task id="4" status="pending">Update DetectionScheduleEditor to use MultiTimeRangePicker (AC: 2, 5)</task>
      <task id="5" status="pending">Update CameraForm integration (AC: 3)</task>
      <task id="6" status="pending">Test and validate (All ACs)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Multiple time ranges per day supported - users can add 2+ non-overlapping time ranges</criterion>
    <criterion id="2">UI allows adding and removing time ranges dynamically (min 1, max 4 per day)</criterion>
    <criterion id="3">Database schema stores multiple ranges in existing JSON column (no migration needed)</criterion>
    <criterion id="4">Schedule evaluation handles multiple ranges - detection active if current time falls within ANY range</criterion>
    <criterion id="5">Overlapping ranges are validated and merged or rejected with clear error message</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD-phase5.md</path>
        <title>ArgusAI Phase 5 PRD</title>
        <section>FR35</section>
        <snippet>Users can define multiple active time ranges per day for detection schedules. This enables schedules like 6-9am AND 6-11pm for morning/evening monitoring.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase5.md</path>
        <title>Phase 5 Epics</title>
        <section>P5-5.4</section>
        <snippet>Story P5-5.4 implements multiple schedule time ranges. ACs include: multiple ranges per day, add/remove UI, database support, evaluation handling, overlap validation.</snippet>
      </doc>
      <doc>
        <path>docs/backlog.md</path>
        <title>Project Backlog</title>
        <section>FF-016</section>
        <snippet>Feature request: Extend detection schedule to support multiple time ranges per day. Current implementation only supports single time range. GitHub Issue #41.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/p5-5-3-create-detection-zone-preset-templates.md</path>
        <title>Previous Story - Detection Zone Presets</title>
        <section>Dev Agent Record</section>
        <snippet>Focus ring pattern: focus:outline-none focus-visible:ring-2. All buttons need aria-label for accessibility. Component tests with Vitest covering all interaction states.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>backend/app/services/schedule_manager.py</path>
        <kind>service</kind>
        <symbol>ScheduleManager.is_detection_active()</symbol>
        <lines>53-176</lines>
        <reason>Core schedule evaluation logic. Must be updated to iterate over time_ranges array. Currently handles single start_time/end_time at root level.</reason>
      </file>
      <file>
        <path>backend/tests/test_services/test_schedule_manager.py</path>
        <kind>test</kind>
        <symbol>TestScheduleManager</symbol>
        <lines>1-360</lines>
        <reason>Existing test suite for schedule validation. Need to add tests for multiple time ranges, legacy format handling, and overlap scenarios.</reason>
      </file>
      <file>
        <path>frontend/components/cameras/DetectionScheduleEditor.tsx</path>
        <kind>component</kind>
        <symbol>DetectionScheduleEditor</symbol>
        <lines>1-352</lines>
        <reason>Current schedule UI with single time range. Replace time inputs with new MultiTimeRangePicker component.</reason>
      </file>
      <file>
        <path>frontend/types/camera.ts</path>
        <kind>types</kind>
        <symbol>IDetectionSchedule</symbol>
        <lines>55-63</lines>
        <reason>Schedule type definition. Add ITimeRange interface and update IDetectionSchedule to use time_ranges array.</reason>
      </file>
      <file>
        <path>frontend/lib/validations/camera.ts</path>
        <kind>validation</kind>
        <symbol>detectionScheduleSchema</symbol>
        <lines>31-36</lines>
        <reason>Zod schema for schedule validation. Update to validate time_ranges array and add overlap detection.</reason>
      </file>
      <file>
        <path>frontend/components/cameras/CameraForm.tsx</path>
        <kind>component</kind>
        <symbol>CameraForm</symbol>
        <reason>Parent form using DetectionScheduleEditor. Update form defaults and ensure time_ranges format is used.</reason>
      </file>
      <file>
        <path>frontend/components/cameras/ZonePresetTemplates.tsx</path>
        <kind>component</kind>
        <symbol>ZonePresetTemplates</symbol>
        <reason>Reference pattern for button styling, aria-labels, and accessibility. Follow same patterns for add/remove time range buttons.</reason>
      </file>
      <file>
        <path>frontend/components/rules/TimeRangePicker.tsx</path>
        <kind>component</kind>
        <symbol>TimeRangePicker</symbol>
        <reason>Existing time picker in alert rules. May provide reusable patterns for time input styling.</reason>
      </file>
    </code>
    <dependencies>
      <backend>
        <package name="fastapi" version="0.115.0">Web framework</package>
        <package name="pydantic" version="2.10.0">Data validation (schema accepts Any for detection_schedule)</package>
        <package name="pytest" version="7.4.3">Testing framework</package>
      </backend>
      <frontend>
        <package name="next" version="16.0.10">React framework</package>
        <package name="react" version="19.2.0">UI library</package>
        <package name="react-hook-form" version="7.66.0">Form management</package>
        <package name="zod" version="4.1.12">Schema validation</package>
        <package name="lucide-react" version="0.553.0">Icons for add/remove buttons</package>
        <package name="@radix-ui/react-tooltip" version="1.2.8">Tooltip for overnight warning</package>
        <package name="vitest" version="4.0.15">Testing framework</package>
        <package name="@testing-library/react" version="16.3.0">React testing utilities</package>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="backward-compatibility">
      Backend ScheduleManager must support both formats: legacy single range (start_time/end_time at root) and new array format (time_ranges). Frontend should migrate legacy format on load.
    </constraint>
    <constraint type="no-migration">
      No database migration required. detection_schedule column is TEXT storing JSON. Schema change is JSON-only.
    </constraint>
    <constraint type="api-schema">
      No API schema change required. detection_schedule field remains Optional[Any] accepting JSON object or string.
    </constraint>
    <constraint type="max-ranges">
      Maximum 4 time ranges per schedule to keep UI manageable and prevent complexity.
    </constraint>
    <constraint type="overlap-validation">
      Overlapping time ranges must be rejected with clear user-facing error message. Consider overnight ranges (22:00-06:00) which span midnight.
    </constraint>
    <constraint type="accessibility">
      All add/remove buttons must have aria-labels. Focus ring pattern: focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2.
    </constraint>
    <constraint type="fail-open">
      Backend schedule evaluation must fail-open (return True) for any parsing or validation errors to maintain detection continuity.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ITimeRange</name>
      <kind>TypeScript interface</kind>
      <signature>
interface ITimeRange {
  start_time: string; // Format: "HH:MM" (24-hour)
  end_time: string;   // Format: "HH:MM" (24-hour)
}
      </signature>
      <path>frontend/types/camera.ts</path>
    </interface>
    <interface>
      <name>IDetectionSchedule (updated)</name>
      <kind>TypeScript interface</kind>
      <signature>
interface IDetectionSchedule {
  enabled: boolean;
  time_ranges: ITimeRange[]; // NEW: Array of time ranges (min 1, max 4)
  days: number[];            // 0-6 (Monday-Sunday per Python weekday())
  // Legacy fields for backward compatibility:
  start_time?: string;       // DEPRECATED: Use time_ranges instead
  end_time?: string;         // DEPRECATED: Use time_ranges instead
}
      </signature>
      <path>frontend/types/camera.ts</path>
    </interface>
    <interface>
      <name>ScheduleManager.is_detection_active()</name>
      <kind>Python method</kind>
      <signature>
def is_detection_active(
    self,
    camera_id: str,
    detection_schedule: Optional[str]
) -> bool:
    """
    Check if motion detection should be active based on schedule.

    Args:
        camera_id: UUID of camera (for logging)
        detection_schedule: JSON string with time_ranges array or legacy format

    Returns:
        True if detection should be active (within ANY time range), False otherwise
    """
      </signature>
      <path>backend/app/services/schedule_manager.py</path>
    </interface>
    <interface>
      <name>MultiTimeRangePicker</name>
      <kind>React component</kind>
      <signature>
interface MultiTimeRangePickerProps {
  value: ITimeRange[];
  onChange: (ranges: ITimeRange[]) => void;
  maxRanges?: number; // Default: 4
  disabled?: boolean;
}

export function MultiTimeRangePicker({
  value,
  onChange,
  maxRanges = 4,
  disabled = false
}: MultiTimeRangePickerProps): JSX.Element;
      </signature>
      <path>frontend/components/cameras/MultiTimeRangePicker.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend tests use pytest with pytest-asyncio. Frontend tests use Vitest with React Testing Library and jest-dom matchers. Tests should be co-located in __tests__ directories. Component tests should cover all user interactions, accessibility (aria-labels, keyboard navigation), and edge cases. Backend tests should mock datetime.now() to test specific time scenarios.
    </standards>
    <locations>
      <location>backend/tests/test_services/test_schedule_manager.py</location>
      <location>frontend/__tests__/components/cameras/</location>
    </locations>
    <ideas>
      <idea ac="1">Test adding 2-4 time ranges and verifying all are stored correctly</idea>
      <idea ac="2">Test add button disabled when max ranges reached (4)</idea>
      <idea ac="2">Test remove button removes correct range and updates array</idea>
      <idea ac="2">Test keyboard navigation for add/remove buttons (Enter/Space)</idea>
      <idea ac="3">Test form submission serializes time_ranges to JSON correctly</idea>
      <idea ac="4">Test backend evaluation: active when current time within first range only</idea>
      <idea ac="4">Test backend evaluation: active when current time within second range only</idea>
      <idea ac="4">Test backend evaluation: inactive when current time outside all ranges</idea>
      <idea ac="4">Test backend with legacy single-range format (backward compatibility)</idea>
      <idea ac="4">Test overnight range (22:00-06:00) in multi-range context</idea>
      <idea ac="5">Test overlap validation rejects overlapping ranges</idea>
      <idea ac="5">Test adjacent ranges (09:00-12:00 and 12:00-17:00) are allowed</idea>
      <idea ac="5">Test validation error message is user-friendly</idea>
    </ideas>
  </tests>
</story-context>
