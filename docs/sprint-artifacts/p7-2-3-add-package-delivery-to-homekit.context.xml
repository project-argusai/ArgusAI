<story-context id="p7-2-3" v="1.0">
  <metadata>
    <epicId>P7-2</epicId>
    <storyId>P7-2.3</storyId>
    <title>Add Package Delivery to HomeKit</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/p7-2-3-add-package-delivery-to-homekit.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>homeowner using ArgusAI with HomeKit</asA>
    <iWant>the HomeKit package sensor to trigger when a package delivery is detected with carrier information logged</iWant>
    <soThat>I can create HomeKit automations for package deliveries and debug carrier detection issues</soThat>
    <tasks>
      <task id="1" ac="1,2,4">Update HomeKit Package Trigger to Include Carrier
        <subtask id="1.1">Modify trigger_package() method signature to accept optional delivery_carrier parameter</subtask>
        <subtask id="1.2">Update _trigger_homekit_package() in event_processor.py to pass carrier from event</subtask>
        <subtask id="1.3">Add carrier to HomeKit package trigger logging (diagnostic_category: event)</subtask>
        <subtask id="1.4">Write unit tests for carrier in package trigger logging</subtask>
      </task>
      <task id="2" ac="3">Add Per-Carrier Sensor Configuration
        <subtask id="2.1">Add HOMEKIT_PER_CARRIER_SENSORS environment variable (default: false)</subtask>
        <subtask id="2.2">Add per_carrier_sensors to HomekitConfig dataclass</subtask>
        <subtask id="2.3">Update homekit_service.py start() to create per-carrier sensors when enabled</subtask>
        <subtask id="2.4">Add _carrier_sensors dict mapping carrier to sensor for per-carrier mode</subtask>
        <subtask id="2.5">Add trigger_carrier_package() method for triggering specific carrier sensor</subtask>
        <subtask id="2.6">Update trigger_package() to call carrier-specific sensor when per-carrier mode enabled</subtask>
      </task>
      <task id="3" ac="3">Add Per-Carrier Sensor Accessories
        <subtask id="3.1">Create CameraCarrierPackageSensor class in homekit_accessories.py (extends CameraPackageSensor)</subtask>
        <subtask id="3.2">Add carrier-specific naming (e.g., "Front Door FedEx Package")</subtask>
        <subtask id="3.3">Create create_carrier_package_sensor() factory function</subtask>
        <subtask id="3.4">Write unit tests for carrier sensor creation</subtask>
      </task>
      <task id="4" ac="1,2,4">Integration Testing
        <subtask id="4.1">Test package delivery triggers HomeKit package sensor when carrier is set</subtask>
        <subtask id="4.2">Test carrier info appears in HomeKit logs</subtask>
        <subtask id="4.3">Test per-carrier sensor mode creates separate sensors</subtask>
        <subtask id="4.4">Test per-carrier sensor triggers correct carrier sensor</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Existing package sensor triggered on delivery detection (when delivery_carrier is set on event)</criterion>
    <criterion id="2">Carrier info logged for debugging when HomeKit package sensor is triggered</criterion>
    <criterion id="3">Separate sensors per carrier option available via configuration (optional enhancement)</criterion>
    <criterion id="4">Delivery detection logged with carrier context</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-P7-2.md</path>
        <title>Epic Technical Specification: Package Delivery Alerts</title>
        <section>Story P7-2.3: Add Package Delivery to HomeKit</section>
        <snippet>Trigger existing package sensor on delivery detection. Add carrier info to HomeKit accessory name/metadata if possible. Create separate sensors per carrier (optional config). Log carrier detection for debugging.</snippet>
      </doc>
      <doc>
        <path>docs/epics-phase7.md</path>
        <title>Phase 7 Epics: HomeKit Integration &amp; Enhancements</title>
        <section>Story P7-2.3: Add Package Delivery to HomeKit</section>
        <snippet>Trigger HomeKit package sensor when delivery is detected with carrier info. Acceptance criteria: trigger existing sensor, add carrier metadata if possible, create per-carrier sensors optionally, log carrier detection.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/p7-2-2-create-package-delivery-alert-rule-type.md</path>
        <title>Story P7-2.2: Create Package Delivery Alert Rule Type</title>
        <section>Dev Agent Record</section>
        <snippet>Previous story completed. Created carrier extractor service, added delivery_carrier to Event model, updated alert engine for package_delivery rule type. Patterns established for carrier handling.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>backend/app/services/homekit_service.py</path>
        <kind>service</kind>
        <symbol>HomekitService.trigger_package</symbol>
        <lines>1427-1464</lines>
        <reason>Main method to trigger HomeKit package sensor - needs carrier parameter added</reason>
      </file>
      <file>
        <path>backend/app/services/homekit_service.py</path>
        <kind>service</kind>
        <symbol>HomekitService._package_sensors</symbol>
        <lines>152</lines>
        <reason>Package sensor dictionary - may need per-carrier variant</reason>
      </file>
      <file>
        <path>backend/app/services/homekit_accessories.py</path>
        <kind>accessory</kind>
        <symbol>CameraPackageSensor</symbol>
        <lines>524-608</lines>
        <reason>Package sensor accessory class - base for carrier-specific sensors</reason>
      </file>
      <file>
        <path>backend/app/services/homekit_accessories.py</path>
        <kind>factory</kind>
        <symbol>create_package_sensor</symbol>
        <lines>610-641</lines>
        <reason>Factory function for package sensors - pattern to follow for carrier sensors</reason>
      </file>
      <file>
        <path>backend/app/services/event_processor.py</path>
        <kind>processor</kind>
        <symbol>EventProcessor._trigger_homekit_package</symbol>
        <lines>1684-1732</lines>
        <reason>Calls trigger_package() - needs to pass carrier from event</reason>
      </file>
      <file>
        <path>backend/app/services/event_processor.py</path>
        <kind>processor</kind>
        <symbol>package detection trigger</symbol>
        <lines>1090-1098</lines>
        <reason>Where HomeKit package trigger is created - carrier available from event</reason>
      </file>
      <file>
        <path>backend/app/services/carrier_extractor.py</path>
        <kind>service</kind>
        <symbol>CARRIER_DISPLAY_NAMES</symbol>
        <lines>47-53</lines>
        <reason>Carrier display names mapping - use for sensor names</reason>
      </file>
      <file>
        <path>backend/app/config/homekit.py</path>
        <kind>config</kind>
        <symbol>HomekitConfig</symbol>
        <lines>238-277</lines>
        <reason>HomeKit configuration - needs per_carrier_sensors option</reason>
      </file>
      <file>
        <path>backend/app/config/homekit.py</path>
        <kind>config</kind>
        <symbol>get_homekit_config</symbol>
        <lines>295-337</lines>
        <reason>Config loader - needs HOMEKIT_PER_CARRIER_SENSORS env var</reason>
      </file>
      <file>
        <path>backend/tests/test_services/test_alert_engine_package_delivery.py</path>
        <kind>test</kind>
        <symbol>test_package_delivery_*</symbol>
        <lines>all</lines>
        <reason>Package delivery tests - patterns for testing carrier in HomeKit</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="HAP-python" version="4.9+">HomeKit Accessory Protocol implementation</package>
        <package name="pyhap">HAP-python package name in imports</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Follow existing sensor trigger patterns in homekit_service.py (trigger_motion, trigger_occupancy, trigger_vehicle, etc.)</constraint>
    <constraint type="pattern">Use diagnostic_category: "event" in logging extra dict for HomeKit event logging</constraint>
    <constraint type="pattern">Per-carrier sensors should be optional and off by default (backwards compatible)</constraint>
    <constraint type="performance">HomeKit triggering must not block event processing - use asyncio.create_task()</constraint>
    <constraint type="naming">Sensor names should follow pattern: "{Camera Name} {Carrier} Package" for per-carrier sensors</constraint>
    <constraint type="carrier">Valid carriers: fedex, ups, usps, amazon, dhl (lowercase)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>HomekitService.trigger_package</name>
      <kind>method</kind>
      <signature>def trigger_package(self, camera_id: str, event_id: Optional[int] = None) -> bool</signature>
      <path>backend/app/services/homekit_service.py:1427</path>
      <note>Add optional delivery_carrier: Optional[str] = None parameter</note>
    </interface>
    <interface>
      <name>_trigger_homekit_package</name>
      <kind>method</kind>
      <signature>async def _trigger_homekit_package(self, homekit_service, camera_id: str, event_id: str) -> None</signature>
      <path>backend/app/services/event_processor.py:1684</path>
      <note>Add delivery_carrier parameter and pass to trigger_package</note>
    </interface>
    <interface>
      <name>CARRIER_DISPLAY_NAMES</name>
      <kind>constant</kind>
      <signature>Dict[str, str] = {'fedex': 'FedEx', 'ups': 'UPS', 'usps': 'USPS', 'amazon': 'Amazon', 'dhl': 'DHL'}</signature>
      <path>backend/app/services/carrier_extractor.py:47</path>
      <note>Use for per-carrier sensor naming</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend tests use pytest with fixtures. Test files in backend/tests/test_services/.
      Follow patterns from test_alert_engine_package_delivery.py for carrier-related tests.
      Mock HomeKit sensors and events. Use pytest fixtures for common setup.
      Test both normal operation and error handling paths.
    </standards>
    <locations>
      <location>backend/tests/test_services/</location>
      <location>backend/tests/test_api/</location>
    </locations>
    <ideas>
      <test ac="1">trigger_package() triggers sensor when delivery_carrier is set on event</test>
      <test ac="2">trigger_package() logs carrier info with diagnostic_category: event</test>
      <test ac="3">start() creates per-carrier sensors when HOMEKIT_PER_CARRIER_SENSORS=true</test>
      <test ac="3">trigger_package() routes to carrier-specific sensor when per-carrier mode enabled</test>
      <test ac="4">_trigger_homekit_package() passes carrier from event to trigger_package()</test>
      <test ac="1">trigger_package() works without carrier (backward compatibility)</test>
      <test ac="3">Per-carrier sensors have correct names (e.g., "Front Door FedEx Package")</test>
    </ideas>
  </tests>
</story-context>
