<?xml version="1.0" encoding="UTF-8"?>
<story-context story-key="p8-4-3-create-argusai-api-specification-for-mobile" generated="2025-12-24">
  <metadata>
    <epic>Epic P8-4: Native iOS Application</epic>
    <phase>Phase 8: Advanced UX</phase>
    <dependencies>
      <dependency story="p8-4-1" status="done">Research native Apple app technologies</dependency>
      <dependency story="p8-4-2" status="done">Design cloud relay architecture</dependency>
    </dependencies>
  </metadata>

  <project-context>
    <description>
      ArgusAI is an AI-powered event detection system for home security that analyzes
      video feeds from UniFi Protect cameras, RTSP IP cameras, and USB webcams. This
      story creates a comprehensive OpenAPI specification for the mobile API endpoints
      that will be used by the iOS application.
    </description>
    <tech-stack>
      <backend>FastAPI 0.115, SQLAlchemy 2.0, Python 3.11+</backend>
      <api-format>OpenAPI 3.1</api-format>
      <authentication>JWT Bearer tokens, device pairing with 6-digit codes</authentication>
    </tech-stack>
  </project-context>

  <architecture-decisions>
    <decision id="cloud-relay">
      <source>docs/architecture/cloud-relay-design.md</source>
      <summary>
        - Primary relay: Cloudflare Tunnel (argo-tunnel) for remote access
        - Fallback: Tailscale for direct mesh networking
        - Authentication: 6-digit pairing codes (5-min TTL), JWT tokens
        - Token lifecycle: 1h access token, 30d refresh token with rotation
      </summary>
    </decision>
    <decision id="mobile-optimization">
      <source>docs/sprint-artifacts/tech-spec-epic-P8-4.md</source>
      <summary>
        - Compressed thumbnails: JPEG quality 60, max 50KB
        - Compressed snapshots: JPEG quality 75, max 100KB
        - Paginated responses: default 20 items, max 100
        - Rate limiting per endpoint for abuse prevention
      </summary>
    </decision>
    <decision id="security">
      <source>docs/architecture/cloud-relay-design.md</source>
      <summary>
        - TLS 1.3 required for all connections
        - Certificate pinning for production app
        - Device ID binding to prevent token theft
        - Refresh token rotation on each use
        - Rate limiting: 5 pair requests/min, 10 verify/min, 20 refresh/min
      </summary>
    </decision>
  </architecture-decisions>

  <existing-patterns>
    <pattern name="events-api" file="backend/app/api/v1/events.py">
      <description>
        Existing events API follows these patterns:
        - GET /events with query params: camera_id, start_time, end_time, limit, offset
        - GET /events/{event_id} for single event detail
        - Response includes EventResponse schema with thumbnail_path, description, confidence
        - Pagination using limit/offset with total_count and has_more
        - Filtering by source_type, smart_detection_type, etc.
      </description>
    </pattern>
    <pattern name="push-api" file="backend/app/api/v1/push.py">
      <description>
        Existing push API patterns:
        - POST /subscribe with endpoint and keys
        - DELETE /subscribe for unsubscription
        - Pydantic schemas for request/response validation
        - VAPID public key endpoint
      </description>
    </pattern>
    <pattern name="cameras-api" file="backend/app/api/v1/cameras.py">
      <description>
        Existing camera API patterns:
        - GET /cameras returns List[CameraResponse]
        - Camera status with is_enabled, source_type
        - Snapshot endpoints for current frame
      </description>
    </pattern>
    <pattern name="error-responses">
      <description>
        Standard error response format:
        - 400: {"detail": "Invalid request data"}
        - 401: {"detail": "Not authenticated"}
        - 404: {"detail": "Resource not found"}
        - 429: {"detail": "Rate limit exceeded"}
        - 500: {"detail": "Internal server error"}
      </description>
    </pattern>
  </existing-patterns>

  <api-endpoints-to-document>
    <endpoint-group name="authentication">
      <endpoint method="POST" path="/api/v1/mobile/auth/pair">
        <description>Generate a 6-digit pairing code for device registration</description>
        <request>{"device_id": "uuid", "device_name": "iPhone 15", "device_model": "iPhone15,2"}</request>
        <response>{"pairing_code": "123456", "expires_at": "2025-12-24T12:35:00Z"}</response>
        <rate-limit>5/minute</rate-limit>
      </endpoint>
      <endpoint method="POST" path="/api/v1/mobile/auth/verify">
        <description>Verify pairing code and receive JWT tokens</description>
        <request>{"pairing_code": "123456", "device_id": "uuid"}</request>
        <response>{"access_token": "...", "refresh_token": "...", "expires_in": 3600}</response>
        <rate-limit>10/minute</rate-limit>
      </endpoint>
      <endpoint method="POST" path="/api/v1/mobile/auth/refresh">
        <description>Refresh access token using refresh token</description>
        <request>{"refresh_token": "..."}</request>
        <response>{"access_token": "...", "refresh_token": "...", "expires_in": 3600}</response>
        <rate-limit>20/minute</rate-limit>
      </endpoint>
    </endpoint-group>

    <endpoint-group name="events">
      <endpoint method="GET" path="/api/v1/mobile/events">
        <description>List events with pagination and filtering</description>
        <query-params>
          <param name="camera_id" type="string" optional="true"/>
          <param name="start_time" type="datetime" optional="true"/>
          <param name="end_time" type="datetime" optional="true"/>
          <param name="limit" type="int" default="20" max="100"/>
          <param name="offset" type="int" default="0"/>
        </query-params>
        <response-size>~5KB for 20 events</response-size>
        <rate-limit>100/minute</rate-limit>
      </endpoint>
      <endpoint method="GET" path="/api/v1/mobile/events/{event_id}">
        <description>Get single event detail</description>
        <response-size>~1KB</response-size>
      </endpoint>
      <endpoint method="GET" path="/api/v1/mobile/events/{event_id}/thumbnail">
        <description>Get compressed thumbnail image</description>
        <response-size>30-50KB (JPEG quality 60)</response-size>
        <content-type>image/jpeg</content-type>
      </endpoint>
      <endpoint method="GET" path="/api/v1/mobile/events/recent">
        <description>Get last N events for widgets (minimal data)</description>
        <query-params>
          <param name="limit" type="int" default="5" max="10"/>
        </query-params>
        <response-size>~2KB</response-size>
      </endpoint>
    </endpoint-group>

    <endpoint-group name="cameras">
      <endpoint method="GET" path="/api/v1/mobile/cameras">
        <description>List cameras with status</description>
        <response-size>~2KB</response-size>
      </endpoint>
      <endpoint method="GET" path="/api/v1/mobile/cameras/{camera_id}/snapshot">
        <description>Get current camera snapshot</description>
        <response-size>50-100KB (JPEG quality 75)</response-size>
        <content-type>image/jpeg</content-type>
        <rate-limit>30/minute</rate-limit>
      </endpoint>
    </endpoint-group>

    <endpoint-group name="push">
      <endpoint method="POST" path="/api/v1/mobile/push/register">
        <description>Register APNS device token for push notifications</description>
        <request>{"device_token": "apns-token", "device_id": "uuid"}</request>
      </endpoint>
      <endpoint method="DELETE" path="/api/v1/mobile/push/unregister">
        <description>Unregister device from push notifications</description>
      </endpoint>
    </endpoint-group>
  </api-endpoints-to-document>

  <security-schemas>
    <schema name="BearerAuth">
      <type>http</type>
      <scheme>bearer</scheme>
      <bearer-format>JWT</bearer-format>
    </schema>
    <header name="Authorization" format="Bearer {access_token}" required="true"/>
    <header name="X-Device-ID" required="true" description="Unique device identifier"/>
  </security-schemas>

  <rate-limits-summary>
    <limit endpoint="POST /auth/pair" limit="5" window="1 min"/>
    <limit endpoint="POST /auth/verify" limit="10" window="1 min"/>
    <limit endpoint="POST /auth/refresh" limit="20" window="1 min"/>
    <limit endpoint="GET /events" limit="100" window="1 min"/>
    <limit endpoint="GET /cameras/*/snapshot" limit="30" window="1 min"/>
  </rate-limits-summary>

  <bandwidth-estimates>
    <estimate endpoint="/events (page)" size="3-5 KB" notes="20 events, no thumbnails"/>
    <estimate endpoint="/events/{id}" size="500 B - 1 KB" notes="Single event detail"/>
    <estimate endpoint="/events/{id}/thumbnail" size="30-50 KB" notes="JPEG quality 60"/>
    <estimate endpoint="/events/recent" size="1-2 KB" notes="5 events, minimal data"/>
    <estimate endpoint="/cameras" size="1-2 KB" notes="Camera list"/>
    <estimate endpoint="/cameras/{id}/snapshot" size="50-100 KB" notes="JPEG compressed"/>
  </bandwidth-estimates>

  <output-requirements>
    <requirement>OpenAPI 3.1 specification</requirement>
    <requirement>Save to docs/api/mobile-api.yaml</requirement>
    <requirement>Include all endpoints with request/response schemas</requirement>
    <requirement>Document rate limits using x-ratelimit extension</requirement>
    <requirement>Include security schemes</requirement>
    <requirement>Add bandwidth estimates in descriptions</requirement>
  </output-requirements>

  <references>
    <ref type="tech-spec">docs/sprint-artifacts/tech-spec-epic-P8-4.md</ref>
    <ref type="architecture">docs/architecture/cloud-relay-design.md</ref>
    <ref type="story">docs/sprint-artifacts/p8-4-3-create-argusai-api-specification-for-mobile.md</ref>
    <ref type="existing-api">backend/app/api/v1/events.py</ref>
    <ref type="existing-api">backend/app/api/v1/push.py</ref>
    <ref type="existing-api">backend/app/api/v1/cameras.py</ref>
  </references>
</story-context>
